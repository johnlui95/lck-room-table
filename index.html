<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  <meta charset='utf-8' />
Â  <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
Â  body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; overflow: hidden; }
Â Â 
Â  #smart-input-panel {
Â  Â  position: fixed; top: 20px; right: 20px; width: 320px; z-index: 999;
Â  Â  background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
Â  Â  border: 1px solid #e2e8f0; overflow: hidden;
Â  }
Â  #panel-header { background: #6366f1; color: white; padding: 10px 15px; cursor: move; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
Â  #panel-content { padding: 15px; }
Â  #ai-text-input { width: 100%; height: 100px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; resize: vertical; margin-bottom: 10px; }
Â  #parse-btn { background: #6366f1; color: white; border: none; width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
Â Â 
Â  #calendar { max-width: 100%; height: 100vh; background: #fff; padding: 10px; }

Â  #custom-menu {
Â  Â  display: none; position: fixed; z-index: 10000;
Â  Â  background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
Â  Â  width: 180px; border: 1px solid #e2e8f0; overflow: hidden;
Â  }
Â  .menu-item { padding: 12px 15px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; }
Â  .menu-item:hover { background: #f8fafc; }
Â Â 
Â  /* âœ¨ é¸ä¸­ç‹€æ…‹çš„è¦–è¦ºæ•ˆæœ - ç›´æ¥ä½œç”¨æ–¼ event å®¹å™¨ */
Â  .fc-event-selected {
Â  Â  border: 3px solid #facc15 !important;
Â  Â  box-shadow: 0 0 12px rgba(250, 204, 21, 0.9) !important;
Â  Â  z-index: 99 !important;
Â  }

Â  .hour-label { font-weight: bold; color: #1e293b; font-size: 14px; }
Â  .minute-label { font-size: 11px; color: #94a3b8; }
Â  .event-inner { padding: 2px; color: white; line-height: 1.2; height: 100%; }
Â  .event-time { font-size: 10px; opacity: 0.9; margin-bottom: 2px; }
Â  .event-title { font-size: 13px; font-weight: bold; display: block; }
Â  .event-teacher { font-size: 11px; margin-top: 2px; display: flex; align-items: center; }

Â  @media (max-width: 768px) {
Â  Â  #smart-input-panel { width: 90%; right: 5%; top: 10px; }
Â  Â  .fc-header-toolbar { flex-direction: column; font-size: 12px; }
Â  }
</style>
</head>
<body>

Â  <div id="custom-menu">
Â  Â  <div class="menu-item" onclick="handleAction('toggleSelect')">âœ… é¸å– / å–æ¶ˆ</div>
Â  Â  <div class="menu-item" onclick="handleAction('editName')">âœï¸ ä¿®æ”¹å­¸ç”Ÿå</div>
Â  Â  <div class="menu-item" onclick="handleAction('editTeacher')">ğŸ‘¤ ä¿®æ”¹è€å¸«å</div>
Â  Â  <div class="menu-item" onclick="handleAction('copy')">ğŸ“‹ è¤‡è£½èª²å ‚</div>
Â  Â  <div class="menu-item" style="color:red;" onclick="handleAction('delete')">ğŸ—‘ï¸ åˆªé™¤ (å«é¸ä¸­)</div>
Â  </div>

Â  <div id="smart-input-panel">
Â  Â  <div id="panel-header"><span>é›²ç«¯æ’èª²åŠ©æ‰‹</span><button id="toggle-btn" style="cursor:pointer; background:none; border:none; color:white;">æ”¶èµ·</button></div>
Â  Â  <div id="panel-content">
Â  Â  Â  <textarea id="ai-text-input" placeholder="åœ¨æ­¤è²¼ä¸Šè¨Šæ¯å…§å®¹..."></textarea>
Â  Â  Â  <button id="parse-btn">è§£æä¸¦åŒæ­¥è‡³é›²ç«¯</button>
Â  Â  </div>
Â  </div>

Â  <div id='calendar'></div>

Â  <script>
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyAFPtHLY-LqLnDiKUot0mpAPchrC7iqAXg",
Â  Â  Â  authDomain: "lckroomtable.firebaseapp.com",
Â  Â  Â  databaseURL: "https://lckroomtable-default-rtdb.firebaseio.com",
Â  Â  Â  projectId: "lckroomtable",
Â  Â  Â  storageBucket: "lckroomtable.firebasestorage.app",
Â  Â  Â  messagingSenderId: "934661729012",
Â  Â  Â  appId: "1:934661729012:web:14b19af989cd72b2370ca1"
Â  Â  };

Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.database();
Â  Â  const eventRef = db.ref('bookings');

Â  Â  let copiedEvent = null;
Â  Â  let selectedEventInfo = null;Â 
Â  Â  let multiSelectIds = new Set();Â 

Â  Â  // å–å¾—å”¯ä¸€è¾¨è­˜ç¢¼çš„è£œåŠ©å‡½æ•¸
Â  Â  function getEvId(ev) {
Â  Â  Â  return ev.startStr + "_" + ev.title + "_" + (ev.getResources()[0]?.id || "");
Â  Â  }

Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  var calendarEl = document.getElementById('calendar');
Â  Â  Â  var calendar = new FullCalendar.Calendar(calendarEl, {
Â  Â  Â  Â  initialView: 'resourceTimeGridWeek',
Â  Â  Â  Â  headerToolbar: {
Â  Â  Â  Â  Â  left: 'prev,next today',
Â  Â  Â  Â  Â  center: 'title',
Â  Â  Â  Â  Â  right: 'resourceTimeGridDay,resourceTimeGridWeek'
Â  Â  Â  Â  },
Â  Â  Â  Â  buttonText: { today: 'ä»Šå¤©', resourceTimeGridDay: 'æ—¥', resourceTimeGridWeek: 'é€±' },
Â  Â  Â  Â  locale: 'zh-tw',
Â  Â  Â  Â  schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
Â  Â  Â  Â  datesAboveResources: true,
Â  Â  Â  Â  slotDuration: '00:15:00',
Â  Â  Â  Â  slotLabelInterval: '00:15:00',
Â  Â  Â  Â  slotMinTime: '08:00:00',
Â  Â  Â  Â  slotMaxTime: '22:00:00',
Â  Â  Â  Â  allDaySlot: false,
Â  Â  Â  Â  hiddenDays: [ 0 ],
Â  Â  Â  Â  selectable: true,
Â  Â  Â  Â  editable: true,

Â  Â  Â  Â  eventContent: function(arg) {
Â  Â  Â  Â  Â  const isSelected = multiSelectIds.has(getEvId(arg.event));
Â  Â  Â  Â  Â  // å¦‚æœè¢«é¸ä¸­ï¼Œç›´æ¥åœ¨æ¸²æŸ“æ™‚åŠ ä¸Šé‚Šæ¡†æ¨£å¼
Â  Â  Â  Â  Â  const borderStyle = isSelected ? 'border: 3px solid #facc15; box-shadow: 0 0 8px rgba(250,204,21,0.8);' : '';
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  return {Â 
Â  Â  Â  Â  Â  Â  html: `<div class="event-inner" style="${borderStyle}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="event-time">${arg.timeText}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="event-title">${arg.event.title}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="event-teacher">ğŸ‘¤ ${arg.event.extendedProps.teacher || ''}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>`Â 
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  },

Â  Â  Â  Â  eventChange: () => updateToCloud(),
Â  Â  Â  Â  eventRemove: () => updateToCloud(),

Â  Â  Â  Â  select: function(info) {
Â  Â  Â  Â  Â  if (copiedEvent) {
Â  Â  Â  Â  Â  Â  if (confirm(`è¦è²¼ä¸Šå·²è¤‡è£½çš„ã€Œ${copiedEvent.title}ã€å—ï¼Ÿ`)) {
Â  Â  Â  Â  Â  Â  Â  calendar.addEvent({
Â  Â  Â  Â  Â  Â  Â  Â  title: copiedEvent.title, start: info.startStr, end: info.endStr,
Â  Â  Â  Â  Â  Â  Â  Â  resourceId: info.resource.id, extendedProps: copiedEvent.extendedProps,
Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: copiedEvent.backgroundColor
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  updateToCloud(); calendar.unselect(); return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  var title = prompt('å­¸ç”Ÿå§“åï¼š');
Â  Â  Â  Â  Â  if (title) {
Â  Â  Â  Â  Â  Â  var teacher = prompt('å°å¸«å§“åï¼š', 'ä»¥ç³è€å¸«');
Â  Â  Â  Â  Â  Â  var color = (teacher && teacher !== 'ä»¥ç³è€å¸«') ? '#10b981' : '#6366f1';
Â  Â  Â  Â  Â  Â  calendar.addEvent({
Â  Â  Â  Â  Â  Â  Â  title: title, start: info.startStr, end: info.endStr,
Â  Â  Â  Â  Â  Â  Â  resourceId: info.resource.id, extendedProps: { teacher: teacher || 'ä»¥ç³è€å¸«' },
Â  Â  Â  Â  Â  Â  Â  backgroundColor: color
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  updateToCloud();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  calendar.unselect();
Â  Â  Â  Â  },

Â  Â  Â  Â  eventClick: function(info) {
Â  Â  Â  Â  Â  info.jsEvent.preventDefault();
Â  Â  Â  Â  Â  selectedEventInfo = info.event;
Â  Â  Â  Â  Â  const menu = document.getElementById('custom-menu');
Â  Â  Â  Â  Â  menu.style.display = 'block';
Â  Â  Â  Â  Â  menu.style.left = info.jsEvent.clientX + 'px';
Â  Â  Â  Â  Â  menu.style.top = info.jsEvent.clientY + 'px';
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const closeMenu = (e) => {Â 
Â  Â  Â  Â  Â  Â  if(!menu.contains(e.target)) {Â 
Â  Â  Â  Â  Â  Â  Â  menu.style.display = 'none';Â 
Â  Â  Â  Â  Â  Â  Â  document.removeEventListener('mousedown', closeMenu);Â 
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  setTimeout(() => document.addEventListener('mousedown', closeMenu), 50);
Â  Â  Â  Â  },

Â  Â  Â  Â  resources: [
Â  Â  Â  Â  Â  { id: 'R1', title: 'èª ä¿¡å¤§å»³' }, { id: 'R2', title: 'èª ä¿¡ç´°æˆ¿' },
Â  Â  Â  Â  Â  { id: 'R3', title: 'å˜‰åRm 18' }, { id: 'R4', title: 'å˜‰åRm 12' }, { id: 'R5', title: 'å…¶ä»–' }
Â  Â  Â  Â  ]
Â  Â  Â  });

Â  Â  Â  window.handleAction = function(action) {
Â  Â  Â  Â  if (!selectedEventInfo) return;
Â  Â  Â  Â  const evId = getEvId(selectedEventInfo);

Â  Â  Â  Â  if (action === 'toggleSelect') {
Â  Â  Â  Â  Â  if (multiSelectIds.has(evId)) {
Â  Â  Â  Â  Â  Â  multiSelectIds.delete(evId);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  multiSelectIds.add(evId);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  calendar.render(); // âœ¨ é‡è¦ï¼šå¼·åˆ¶æ—¥æ›†é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºé‚Šæ¡†
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  else if (action === 'editName') {
Â  Â  Â  Â  Â  const n = prompt('æ–°å­¸ç”Ÿå§“åï¼š', selectedEventInfo.title);
Â  Â  Â  Â  Â  if (n) {
Â  Â  Â  Â  Â  Â  selectedEventInfo.setProp('title', n);
Â  Â  Â  Â  Â  Â  updateToCloud();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  else if (action === 'editTeacher') {
Â  Â  Â  Â  Â  const t = prompt('æ–°è€å¸«å§“åï¼š', selectedEventInfo.extendedProps.teacher);
Â  Â  Â  Â  Â  if (t) {
Â  Â  Â  Â  Â  Â  const batch = multiSelectIds.has(evId)Â 
Â  Â  Â  Â  Â  Â  Â  ? calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e)))Â 
Â  Â  Â  Â  Â  Â  Â  : [selectedEventInfo];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  batch.forEach(ev => {
Â  Â  Â  Â  Â  Â  Â  ev.setExtendedProp('teacher', t);
Â  Â  Â  Â  Â  Â  Â  ev.setProp('backgroundColor', (t !== 'ä»¥ç³è€å¸«' ? '#10b981' : '#6366f1'));
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  updateToCloud();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  else if (action === 'copy') {
Â  Â  Â  Â  Â  copiedEvent = { title: selectedEventInfo.title, extendedProps: selectedEventInfo.extendedProps, backgroundColor: selectedEventInfo.backgroundColor };
Â  Â  Â  Â  Â  alert(`å·²è¤‡è£½ã€Œ${selectedEventInfo.title}ã€`);
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  else if (action === 'delete') {
Â  Â  Â  Â  Â  const isMulti = multiSelectIds.has(evId);
Â  Â  Â  Â  Â  const count = isMulti ? multiSelectIds.size : 1;
Â  Â  Â  Â  Â  if (confirm(`ç¢ºå®šåˆªé™¤é€™ ${count} å ‚èª²å—ï¼Ÿ`)) {
Â  Â  Â  Â  Â  Â  if (isMulti) {
Â  Â  Â  Â  Â  Â  Â  calendar.getEvents().forEach(ev => {
Â  Â  Â  Â  Â  Â  Â  Â  if (multiSelectIds.has(getEvId(ev))) ev.remove();
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  multiSelectIds.clear();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  selectedEventInfo.remove();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateToCloud();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  document.getElementById('custom-menu').style.display = 'none';
Â  Â  Â  };

Â  Â  Â  eventRef.on('value', (snapshot) => {
Â  Â  Â  Â  const cloudEvents = snapshot.val() || [];
Â  Â  Â  Â  calendar.removeAllEvents();
Â  Â  Â  Â  calendar.addEventSource(cloudEvents);
Â  Â  Â  });

Â  Â  Â  function updateToCloud() {
Â  Â  Â  Â  const events = calendar.getEvents().map(e => ({
Â  Â  Â  Â  Â  title: e.title, start: e.startStr, end: e.endStr,
Â  Â  Â  Â  Â  resourceId: e.getResources()[0]?.id,
Â  Â  Â  Â  Â  extendedProps: e.extendedProps,
Â  Â  Â  Â  Â  backgroundColor: e.backgroundColor || '#6366f1'
Â  Â  Â  Â  }));
Â  Â  Â  Â  eventRef.set(events);
Â  Â  Â  }

Â  Â  Â  // AI è§£æ
Â  Â  Â  document.getElementById('parse-btn').onclick = function() {
Â  Â  Â  Â  const text = document.getElementById('ai-text-input').value;
Â  Â  Â  Â  if (!text) return;
Â  Â  Â  Â  let nameMatch = text.match(/([^\s\n\d,ï¼Œ.]{2,4})(?=[å·²å·³]ç¹³|åŒå­¸|å…ˆç”Ÿ|å°å§|å­¸è²»)/);
Â  Â  Â  Â  let name = nameMatch ? nameMatch[1] : text.split('\n')[0].substring(0, 3);
Â  Â  Â  Â  let teacher = "ä»¥ç³è€å¸«";
Â  Â  Â  Â  const teacherMatch = text.match(/å°å¸«\s*[ï½œ|:ï¼š]\s*([^\s\n]+)/);
Â  Â  Â  Â  if (teacherMatch) teacher = teacherMatch[1].trim();
Â  Â  Â  Â  const dateMatches = text.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/g);
Â  Â  Â  Â  const timeMatch = text.match(/(\d{1,2}[:ï¼š]\d{2})[-â€“â€”](\d{1,2}[:ï¼š]\d{2})/);
Â  Â  Â  Â  if (dateMatches && timeMatch) {
Â  Â  Â  Â  Â  const startTime = timeMatch[1].replace('ï¼š', ':');
Â  Â  Â  Â  Â  const endTime = timeMatch[2].replace('ï¼š', ':');
Â  Â  Â  Â  Â  let currentYear = new Date().getFullYear();
Â  Â  Â  Â  Â  let color = (teacher !== 'ä»¥ç³è€å¸«') ? '#10b981' : '#6366f1';
Â  Â  Â  Â  Â  dateMatches.forEach(dateStr => {
Â  Â  Â  Â  Â  Â  const m = dateStr.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/);
Â  Â  Â  Â  Â  Â  let rId = text.includes('å¤§å»³')?'R1':(text.includes('ç´°æˆ¿')?'R2':(text.includes('18')?'R3':(text.includes('12')?'R4':'R5')));
Â  Â  Â  Â  Â  Â  calendar.addEvent({
Â  Â  Â  Â  Â  Â  Â  title: name, start: `${currentYear}-${String(m[1]).padStart(2,'0')}-${String(m[2]).padStart(2,'0')}T${startTime.padStart(5,'0')}:00`,
Â  Â  Â  Â  Â  Â  Â  end: `${currentYear}-${String(m[1]).padStart(2,'0')}-${String(m[2]).padStart(2,'0')}T${endTime.padStart(5,'0')}:00`,
Â  Â  Â  Â  Â  Â  Â  resourceId: rId, extendedProps: { teacher: teacher }, backgroundColor: color
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  updateToCloud(); document.getElementById('ai-text-input').value = "";
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  const panel = document.getElementById('smart-input-panel');
Â  Â  Â  const header = document.getElementById('panel-header');
Â  Â  Â  const toggleBtn = document.getElementById('toggle-btn');
Â  Â  Â  const content = document.getElementById('panel-content');
Â  Â  Â  let isDragging = false; let offset = [0,0];
Â  Â  Â  header.onmousedown = (e) => { if(e.target===toggleBtn) return; isDragging = true; offset = [panel.offsetLeft - e.clientX, panel.offsetTop - e.clientY]; };
Â  Â  Â  document.onmousemove = (e) => { if(!isDragging) return; panel.style.left = (e.clientX+offset[0])+'px'; panel.style.top = (e.clientY+offset[1])+'px'; panel.style.right='auto'; };
Â  Â  Â  document.onmouseup = () => isDragging = false;
Â  Â  Â  toggleBtn.onclick = () => { content.style.display = content.style.display==='none'?'block':'none'; toggleBtn.innerText = content.style.display==='none'?'å±•é–‹':'æ”¶èµ·'; };

Â  Â  Â  calendar.render();
Â  Â  });
Â  </script>
</body>
</html>
