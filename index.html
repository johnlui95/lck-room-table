<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset='utf-8' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
  body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; overflow: hidden; }

/* å¼·åˆ¶é–‹å•Ÿè·¨æ¬„ä½é¸å–æ„Ÿæ‡‰ */
.fc-timegrid-cols table {
    pointer-events: all !important;
}

/* è®“æ‹–æ›³æ™‚çš„è—è‰²æ–¹æ¡†å¯ä»¥é¡¯ç¤ºåœ¨æœ€å‰é¢ */
.fc-highlight {
    z-index: 5 !important;
    background: rgba(99, 102, 241, 0.2) !important;
    border: 2px dashed #6366f1 !important;
}

/* ç¢ºä¿æˆ¿é–“æ¨™é¡Œä¸æœƒé®æ“‹æ»‘é¼  */
.fc-col-header-cell {
    pointer-events: auto !important;
}
  
#smart-input-panel {
    position: fixed; 
    top: 20px; 
    left: auto; 
    right: 20px; /* é è¨­é å³ */
    width: 320px; 
    z-index: 9999; /* ç¢ºä¿åœ¨æ—¥æ›†ä¹‹ä¸Š */
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    border: 1px solid #e2e8f0; 
    overflow: hidden;
    touch-action: none; /* é˜²æ­¢ç§»å‹•ç«¯å¹²æ“¾ */
}

#panel-header { 
    background: #6366f1; 
    color: white; 
    padding: 10px 15px; 
    cursor: grab; /* æç¤ºå¯æŠ“å– */
    font-weight: bold; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
}
#panel-header:active { cursor: grabbing; }
  #panel-content { padding: 15px; }
  #ai-text-input { width: 100%; height: 100px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; resize: vertical; margin-bottom: 10px; }
  #parse-btn { background: #6366f1; color: white; border: none; width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
  
  #calendar { max-width: 100%; height: 100vh; background: #fff; padding: 10px; box-sizing: border-box; }

  #custom-menu {
    display: none; position: fixed; z-index: 10000;
    background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    width: 180px; border: 1px solid #e2e8f0; overflow: hidden;
  }
  .menu-item { padding: 12px 15px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
  .menu-item:hover { background: #f8fafc; }
  
  /* é¸ä¸­ç‹€æ…‹çš„è¦–è¦ºæ•ˆæœ */
  .event-selected-style {
    border: 3px solid #facc15 !important;
    box-shadow: 0 0 12px rgba(250, 204, 21, 0.9) !important;
  }

  .hour-label { font-weight: bold; color: #1e293b; font-size: 13px; }
  .minute-label { font-size: 11px; color: #94a3b8; }
  .event-inner { padding: 4px; color: white; line-height: 1.2; height: 100%; border-radius: 4px; box-sizing: border-box; }
  .event-time { font-size: 10px; opacity: 0.9; margin-bottom: 2px; }
  .event-title { font-size: 13px; font-weight: bold; display: block; }
  .event-teacher { font-size: 11px; margin-top: 2px; }

  @media (max-width: 768px) { #smart-input-panel { width: 90%; right: 5%; top: 10px; } }
</style>
</head>
<body>

<div id="custom-menu" style="display:none; position:fixed; z-index:9999; background:white; border:1px solid #ccc; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden;">
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; font-weight: bold; background: #f9fafb;" onclick="handleAction('toggleSelect')">ğŸ”² å–æ¶ˆé¸å–æ­¤èª²å ‚</div>
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="handleAction('editName')">âœï¸ ä¿®æ”¹å­¸ç”Ÿå</div>
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="handleAction('editTeacher')">ğŸ‘©â€ğŸ« ä¿®æ”¹è€å¸«å</div>
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #6366f1;" onclick="handleAction('copy')">ğŸ“‹ Copy é¸ä¸­èª²å ‚</div>
    <div style="padding: 10px 15px; cursor: pointer; color: red;" onclick="handleAction('delete')">ğŸ—‘ï¸ åˆªé™¤é¸ä¸­èª²å ‚</div>
</div>

  <div id="smart-input-panel">
    <div id="panel-header"><span>é›²ç«¯æ’èª²åŠ©æ‰‹</span><button id="toggle-btn" style="cursor:pointer; background:none; border:none; color:white;">æ”¶èµ·</button></div>
    <div id="panel-content">
      <textarea id="ai-text-input" placeholder="åœ¨æ­¤è²¼ä¸Šè¨Šæ¯å…§å®¹..."></textarea>
      <button id="parse-btn">è§£æä¸¦åŒæ­¥è‡³é›²ç«¯</button>
    </div>
  </div>

  <div id='calendar'></div>
  
  <script>
// åŠŸèƒ½æ§åˆ¶ä¸­å¿ƒ
window.handleAction = function(action) {
    if (!selectedEventInfo) return;
    const ev = selectedEventInfo;
    const evId = getEvId(ev);

    switch (action) {
case 'toggleSelect':
    multiSelectIds.delete(evId); // å¾é›†åˆç§»é™¤
    calendar.render();
    document.getElementById('custom-menu').style.display = 'none';
    break;

        case 'editName':
            const newName = prompt('ä¿®æ”¹å­¸ç”Ÿå§“åï¼š', ev.title);
            if (newName) {
                ev.setProp('title', newName);
                updateToCloud();
            }
            break;

        case 'editTeacher':
            const newTeacher = prompt('ä¿®æ”¹å°å¸«å§“åï¼š', ev.extendedProps.teacher);
            if (newTeacher) {
                ev.setExtendedProp('teacher', newTeacher);
                // è‡ªå‹•æ ¹æ“šè€å¸«åå­—æ›´æ–°é¡è‰²
                const bgColor = newTeacher.includes('JK') ? '#10b981' : '#6366f1';
                ev.setProp('backgroundColor', bgColor);
                updateToCloud();
            }
            break;

case 'copy':
    const isMulti = multiSelectIds.has(evId);
    // æ‰¾å‡ºæ‰€æœ‰è¦è¤‡è£½çš„å°è±¡
    const targets = isMulti 
        ? calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e))) 
        : [ev];

    if (targets.length === 0) return;

    // ä»¥æœ€æ—©é–‹å§‹çš„é‚£å ‚èª²ä½œç‚ºåŸºæº–é» (Base Time)
    targets.sort((a, b) => a.start - b.start);
    const startRef = targets[0].start;
    
    // å„²å­˜åˆ°æš«å­˜å€
    copiedEventsBatch = targets.map(e => ({
        title: e.title,
        offset: e.start - startRef, // è¨ˆç®—æ¯å ‚èª²ç›¸å°æ–¼åŸºæº–é»çš„æ™‚é–“å·®
        duration: e.end - e.start, // ç´€éŒ„èª²å ‚é•·åº¦
        // ä¸å›ºå®š resourceIdï¼Œè²¼ä¸Šæ™‚æœƒæ ¹æ“šé»æ“Šä½ç½®è‡ªå‹•åˆ†é…
        extendedProps: { ...e.extendedProps },
        backgroundColor: e.backgroundColor
    }));
    
    alert(`ğŸ“‹ å·²è¤‡è£½ ${targets.length} å ‚èª²ã€‚\næç¤ºï¼šé»æ“Šæ—¥æ›†ä»»ä½•ç©ºç™½æ™‚æ®µå³å¯è²¼ä¸Šã€‚`);
    
    // è¤‡è£½å¾Œå–æ¶ˆé»ƒè‰²é‚Šæ¡†
    multiSelectIds.clear();
    calendar.render();
    break;
        

case 'delete':
            // 1. åˆ¤æ–·ç›®å‰é»æ“Šçš„èª²å ‚æ˜¯å¦åœ¨ã€Œå¤šé¸åå–®ã€ä¸­
            const isDelMulti = multiSelectIds.has(evId);
            let delTargets = [];

            if (isDelMulti) {
                // å¦‚æœæ˜¯åœ¨å¤šé¸ç‹€æ…‹ï¼ŒæŠ“å–æ‰€æœ‰ ID åœ¨é›†åˆä¸­çš„äº‹ä»¶
                delTargets = calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e)));
            } else {
                // å¦‚æœåªæ˜¯å–®é¸ï¼ˆæ²’å‹¾é¸å°±ç›´æ¥é»åˆªé™¤ï¼‰ï¼Œåªåˆªé™¤ç•¶å‰é€™ä¸€å€‹
                delTargets = [ev];
            }

            if (delTargets.length === 0) return;

            if (confirm(`ç¢ºå®šåˆªé™¤é€™ ${delTargets.length} å ‚èª²ï¼Ÿ`)) {
                // 2. åŸ·è¡Œåˆªé™¤ï¼ˆä½¿ç”¨ map é å…ˆå›ºå®šå°è±¡ï¼Œé¿å… remove() æ™‚å½±éŸ¿ filter ç»“æœï¼‰
                delTargets.forEach(e => {
                    e.remove(); 
                });

                // 3. æ¸…ç©ºé¸å–é›†åˆä¸¦åŒæ­¥é›²ç«¯
                multiSelectIds.clear();
                calendar.render(); // å¼·åˆ¶é‡ç¹ªç¢ºä¿è¦–è¦ºæ›´æ–°
                updateToCloud();
                console.log("å¤šé‡åˆªé™¤æˆåŠŸ");
            }
            break;
    }
    document.getElementById('custom-menu').style.display = 'none';
};
    
  
// --- å…¨åŸŸè®Šæ•¸å®šç¾© ---
const firebaseConfig = {
    apiKey: "AIzaSyAFPtHLY-LqLnDiKUot0mpAPchrC7iqAXg",
    authDomain: "lckroomtable.firebaseapp.com",
    databaseURL: "https://lckroomtable-default-rtdb.firebaseio.com",
    projectId: "lckroomtable",
    storageBucket: "lckroomtable.firebasestorage.app",
    messagingSenderId: "934661729012",
    appId: "1:934661729012:web:14b19af989cd72b2370ca1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const eventRef = db.ref('bookings');

let calendar; // å°‡ calendar æå‡è‡³å…¨åŸŸä½œç”¨åŸŸ
let copiedEventsBatch = [];
let selectedEventInfo = null;
let multiSelectIds = new Set();

// è¼”åŠ©å‡½å¼
function getEvId(ev) {
    return ev.startStr + "_" + ev.title + "_" + (ev.getResources()[0]?.id || "");
}

// é›²ç«¯åŒæ­¥å‡½å¼
function updateToCloud() {
    if (!calendar) return;
    const events = calendar.getEvents().map(e => ({
        title: e.title,
        start: e.startStr,
        end: e.endStr,
        resourceId: e.getResources()[0]?.id,
        extendedProps: e.extendedProps,
        backgroundColor: e.backgroundColor || '#6366f1'
    }));
    eventRef.set(events);
}

// ä»‹é¢äº¤äº’é‚è¼¯
document.getElementById('toggle-btn').onclick = function() {
    const content = document.getElementById('panel-content');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        this.innerText = 'æ”¶èµ·';
    } else {
        content.style.display = 'none';
        this.innerText = 'å±•é–‹';
    }
};

// --- æ‹–æ‹½åŠŸèƒ½é‚è¼¯ ---
const panel = document.getElementById('smart-input-panel');
const header = document.getElementById('panel-header');
let active = false;
let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

header.addEventListener("mousedown", dragStart);
document.addEventListener("mousemove", drag);
document.addEventListener("mouseup", dragEnd);

function dragStart(e) {
    if (e.target === header || header.contains(e.target)) {
        if (e.target.id === 'toggle-btn') return;
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;
        active = true;
    }
}
function drag(e) {
    if (active) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        xOffset = currentX;
        yOffset = currentY;
        panel.style.transform = `translate(${currentX}px, ${currentY}px)`;
    }
}
function dragEnd() { active = false; }

// --- ä¸»ç¨‹å¼åˆå§‹åŒ– ---
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'resourceTimeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'resourceTimeGridDay,resourceTimeGridWeek'
        },
        locale: 'zh-tw',
        schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
        datesAboveResources: true,
        slotDuration: '00:15:00',
        slotLabelInterval: '00:15:00',
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        allDaySlot: false,
        editable: true,
        selectable: true,

      // åœ¨ calendar çš„è¨­å®šä¸­åŠ å…¥ï¼š
eventClick: function(info) {
    info.jsEvent.preventDefault();
    const ev = info.event;
    const evId = getEvId(ev);

    // --- æ ¸å¿ƒé‚è¼¯ï¼šé»æ“Šèª²å ‚ç›´æ¥åˆ‡æ›é¸å–ç‹€æ…‹ ---
    if (multiSelectIds.has(evId)) {
        // å¦‚æœå·²ç¶“æ˜¯é¸ä¸­ç‹€æ…‹ï¼Œå‰‡å½ˆå‡ºé¸å–®é€²è¡Œç·¨è¼¯ã€è¤‡è£½æˆ–åˆªé™¤
        showCustomMenu(info);
    } else {
        // å¦‚æœæœªé¸ä¸­ï¼Œé»æ“Šä¸€ä¸‹ç›´æ¥è®Šé»ƒæ¡†ï¼ˆé¸å–ï¼‰
        multiSelectIds.add(evId);
        calendar.render(); // ç«‹å³é¡¯ç¤ºé»ƒæ¡†
        
        // æç¤ºï¼šå¦‚æœæƒ³è¦é»ä¸€ä¸‹å°±å–æ¶ˆï¼Œå¯ä»¥æ”¹æˆï¼š
        // multiSelectIds.has(evId) ? multiSelectIds.delete(evId) : multiSelectIds.add(evId);
    }
},

// æ–°å¢ä¸€å€‹è¼”åŠ©å‡½å¼ä¾†å½ˆå‡ºé¸å–®
function showCustomMenu(info) {
    selectedEventInfo = info.event;
    const menu = document.getElementById('custom-menu');
    menu.style.display = 'block';
    menu.style.left = info.jsEvent.clientX + 'px';
    menu.style.top = info.jsEvent.clientY + 'px';
    
    // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
    const closeMenu = (e) => { 
        if(!menu.contains(e.target)) { 
            menu.style.display = 'none'; 
            document.removeEventListener('mousedown', closeMenu); 
        } 
    };
    setTimeout(() => document.addEventListener('mousedown', closeMenu), 50);
}
      
        dayHeaderContent: (arg) => {
            const date = arg.date;
            const dayName = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][date.getDay()];
            return { html: `<div style="font-weight:bold;">${date.getMonth()+1}/${date.getDate()}</div><div style="font-size:12px;">(${dayName})</div>` };
        },

        slotLabelContent: (arg) => {
            const hour = arg.date.getHours();
            const min = arg.date.getMinutes();
            const ampm = hour >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
            const dH = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            if (min === 0) return { html: `<div class="hour-label">${ampm}${dH}æ™‚</div>` };
            return { html: `<div class="minute-label">${dH}:${min.toString().padStart(2,'0')}</div>` };
        },

        resources: [
            { id: 'R1', title: 'èª ä¿¡å¤§å»³' }, { id: 'R2', title: 'èª ä¿¡ç´°æˆ¿' },
            { id: 'R3', title: 'å˜‰åRm 18' }, { id: 'R4', title: 'å˜‰åRm 12' }, { id: 'R5', title: 'å…¶ä»–' }
        ],

        eventContent: (arg) => {
            const isSelected = multiSelectIds.has(getEvId(arg.event));
            const extraClass = isSelected ? 'event-selected-style' : '';
            return { 
                html: `<div class="event-inner ${extraClass}" style="background-color: ${arg.event.backgroundColor}">
                        <div class="event-time">${arg.timeText}</div>
                        <div class="event-title">${arg.event.title}</div>
                        <div class="event-teacher">ğŸ‘¤ ${arg.event.extendedProps.teacher || ''}</div>
                       </div>` 
            };
        },

        eventChange: updateToCloud,
        eventRemove: updateToCloud,

        // AI è§£ææŒ‰éˆ•é»æ“Šäº‹ä»¶ (ç¢ºä¿åœ¨ calendar åˆå§‹åŒ–å¾Œç¶å®š)
select: function(info) {
    // 1. å¦‚æœæœ‰è¤‡è£½å…§å®¹ï¼Œå„ªå…ˆåŸ·è¡Œè²¼ä¸Š
    if (copiedEventsBatch.length > 0) {
        /* ... æ‚¨çš„è²¼ä¸Šé‚è¼¯ ... */
        if (!confirm(`è¦åœ¨é€™è£¡è²¼ä¸Šå·²è¤‡è£½çš„ ${copiedEventsBatch.length} å ‚èª²å—ï¼Ÿ`)) {
            copiedEventsBatch = [];
            calendar.unselect();
            return;
        }
        const baseTime = info.start;
        copiedEventsBatch.forEach(data => {
            calendar.addEvent({
                title: data.title,
                start: new Date(baseTime.getTime() + data.offset),
                end: new Date(baseTime.getTime() + data.offset + data.duration),
                resourceId: info.resource ? info.resource.id : 'R5',
                extendedProps: data.extendedProps,
                backgroundColor: data.backgroundColor
            });
        });
        updateToCloud();
        calendar.unselect();
        return;
    }

    // 2. æ©«è·¨é¸å–æ ¸å¿ƒé‚è¼¯
    const durationMin = (info.end - info.start) / 1000 / 60;

    if (durationMin > 15) {
        const allEvents = calendar.getEvents();
        const resourceObjects = calendar.getResources();
        const resourceIds = resourceObjects.map(r => r.id);

        // å˜—è©¦æŠ“å–æ‰€æœ‰å¯èƒ½æ¶‰åŠçš„ Resource
        // å¦‚æœ info.resource åªæœ‰ä¸€å€‹ï¼Œä»£è¡¨ç€è¦½å™¨é™åˆ¶äº†ï¼Œæˆ‘å€‘é€éåº§æ¨™ç¯„åœè£œè¶³
        let startResId = info.resource ? info.resource.id : null;
        
        // å–å¾—æ‰€æœ‰é¸ä¸­çš„è³‡æº ID (FullCalendar 6.x æ”¯æ´ info.jsEvent å–å¾—åº§æ¨™)
        let selectedResIds = [startResId];
        
        // å¦‚æœæœ‰æ©«è·¨ï¼Œæˆ‘å€‘æª¢æŸ¥æ‰€æœ‰è³‡æº
        const allResources = calendar.getResources();
        const startIdx = resourceIds.indexOf(startResId);
        
        // å°‹æ‰¾ç›®æ¨™ï¼šåªè¦èª²å ‚çš„æ™‚é–“è½åœ¨ [info.start, info.end] ä¹‹é–“
        // ä¸”ä½ çš„æ»‘é¼ æ‹–æ›³ç¯„åœè¦†è“‹äº†è©²æˆ¿é–“
        let foundAny = false;
        allEvents.forEach(ev => {
            const evStart = ev.start;
            const evResId = ev.getResources()[0]?.id;
            
            // åˆ¤å®šï¼šæ™‚é–“ç¬¦åˆ
            if (evStart >= info.start && evStart < info.end) {
                // å¦‚æœæ˜¯æ©«è·¨é¸å–ï¼Œé€šå¸¸ FullCalendar çš„ select æœƒåœ¨ info.resource æä¾›èµ·å§‹é»
                // ç‚ºäº†è®“å®ƒã€Œæ©«è·¨ã€ï¼Œæˆ‘å€‘æ”¾å¯¬æ¢ä»¶ï¼šåœ¨è©²æ™‚æ®µå…§çš„ã€Œæ‰€æœ‰æˆ¿é–“ã€éƒ½é¸å–
                // å¦‚æœæ‚¨åªæƒ³é¸å–ã€Œç‰¹å®šå¹¾é–“ã€ï¼Œè«‹æŒ‰ä½ Ctrl éµé…åˆåŸæœ¬çš„å–®é¸åŠŸèƒ½
                multiSelectIds.add(getEvId(ev));
                foundAny = true;
            }
        });

        if (foundAny) {
            calendar.render();
            calendar.unselect();
            return;
        }
    }

    // 3. å–®ç´”é»æ“Šï¼šæ–°å¢èª²å ‚
    const title = prompt('å­¸ç”Ÿå§“åï¼š');
    if (title) {
        const teacher = prompt('å°å¸«å§“åï¼š', 'ä»¥ç³è€å¸«');
        const isJK = teacher && teacher.includes('JK');
        calendar.addEvent({
            title: title, start: info.startStr, end: info.endStr,
            resourceId: info.resource.id,
            extendedProps: { teacher: isJK ? 'JKè€å¸«' : (teacher || 'ä»¥ç³è€å¸«') },
            backgroundColor: isJK ? '#10b981' : '#6366f1'
        });
        updateToCloud();
    }
    calendar.unselect();
},


    });

    // ç¶å®š AI è§£ææŒ‰éˆ•
document.getElementById('parse-btn').addEventListener('click', function() {
    const text = document.getElementById('ai-text-input').value.trim();
    if (!text) return;

    // 1. è§£æå­¸ç”Ÿå§“å
    const nameMatch = text.match(/([^\s\n\d,ï¼Œ.]{2,4})(?=[å·²å·³]ç¹³|åŒå­¸|å…ˆç”Ÿ|å°å§|å­¸è²»)/);
    const name = nameMatch ? nameMatch[1] : "æ–°å­¸ç”Ÿ";

    // 2. è§£ææ—¥æœŸèˆ‡æ™‚é–“
    const dateMatches = text.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/g);
    const timeMatch = text.match(/(\d{1,2}[:ï¼š]\d{2})[-â€“â€”](\d{1,2}[:ï¼š]\d{2})/);

    // 3. ğŸ”´ åŠ å¼·ç‰ˆï¼šè§£æè€å¸«åç¨± (æŠ“å–ã€Œ|ã€ä¹‹å¾Œçš„æ–‡å­—)
    let teacherName = 'ä»¥ç³è€å¸«'; // é è¨­å€¼
    const teacherMatch = text.match(/[|ï½œ]\s*(\S+?)(?:è€å¸«)?(?:\n|$|\s)/); 
    if (teacherMatch) {
        teacherName = teacherMatch[1].includes('è€å¸«') ? teacherMatch[1] : teacherMatch[1] + 'è€å¸«';
    } else if (text.includes('JK')) {
        teacherName = 'JKè€å¸«';
    }

    // 4. è‡ªå‹•åˆ†é…èƒŒæ™¯é¡è‰²
    let bgColor = '#6366f1'; // é è¨­ç´«è‰²
    if (teacherName.includes('JK')) bgColor = '#10b981'; // JKè€å¸« ç¶ è‰²
    if (teacherName.includes('ä»¥ç³')) bgColor = '#6366f1'; // ä»¥ç³è€å¸« ç´«è‰²

    if (dateMatches && timeMatch) {
        const startT = timeMatch[1].replace('ï¼š', ':');
        const endT = timeMatch[2].replace('ï¼š', ':');
        
        dateMatches.forEach(dStr => {
            const m = dStr.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/);
            
            calendar.addEvent({
                title: name,
                start: `${new Date().getFullYear()}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${startT.padStart(5,'0')}:00`,
                end: `${new Date().getFullYear()}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${endT.padStart(5,'0')}:00`,
                // æˆ¿é–“åˆ†é…
                resourceId: text.includes('å¤§å»³')?'R1':(text.includes('ç´°æˆ¿')?'R2':(text.includes('18')?'R3':(text.includes('12')?'R4':'R5'))),
                extendedProps: { teacher: teacherName },
                backgroundColor: bgColor
            });
        });
        updateToCloud();
        document.getElementById('ai-text-input').value = "";
        alert(`æˆåŠŸè§£æï¼š${name} (${teacherName})`);
    } else {
        alert("æ ¼å¼ä¸ç¬¦ï¼Œè«‹ç¢ºä¿è¨Šæ¯åŒ…å«æ—¥æœŸèˆ‡æ™‚é–“æ®µã€‚");
    }
});

    // å¾ Firebase è¼‰å…¥è³‡æ–™
    eventRef.on('value', (snap) => {
        calendar.removeAllEvents();
        if (snap.val()) calendar.addEventSource(snap.val());
    });

    calendar.render();
});
    </script>

</body>
</html>
