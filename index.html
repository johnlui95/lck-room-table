<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset='utf-8' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
  body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; overflow: hidden; }
  
#smart-input-panel {
    position: fixed; 
    top: 20px; 
    left: 20px; /* æ”¹ç‚º left æ–¹ä¾¿è¨ˆç®—ä½ç§» */
    width: 320px; 
    z-index: 10001; /* ç¢ºä¿åœ¨è‡ªå®šç¾©é¸å–®ä¹‹ä¸Š */
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    border: 1px solid #e2e8f0; 
    overflow: hidden;
    user-select: none; /* é˜²æ­¢ç§»å‹•æ™‚é¸å–åˆ°æ–‡å­— */
}
  #panel-header { background: #6366f1; color: white; padding: 10px 15px; cursor: move; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
  #panel-content { padding: 15px; }
  #ai-text-input { width: 100%; height: 100px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; resize: vertical; margin-bottom: 10px; }
  #parse-btn { background: #6366f1; color: white; border: none; width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
  
  #calendar { max-width: 100%; height: 100vh; background: #fff; padding: 10px; box-sizing: border-box; }

  #custom-menu {
    display: none; position: fixed; z-index: 10000;
    background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    width: 180px; border: 1px solid #e2e8f0; overflow: hidden;
  }
  .menu-item { padding: 12px 15px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
  .menu-item:hover { background: #f8fafc; }
  
  /* é¸ä¸­ç‹€æ…‹çš„è¦–è¦ºæ•ˆæœ */
  .event-selected-style {
    border: 3px solid #facc15 !important;
    box-shadow: 0 0 12px rgba(250, 204, 21, 0.9) !important;
  }

  .hour-label { font-weight: bold; color: #1e293b; font-size: 13px; }
  .minute-label { font-size: 11px; color: #94a3b8; }
  .event-inner { padding: 4px; color: white; line-height: 1.2; height: 100%; border-radius: 4px; box-sizing: border-box; }
  .event-time { font-size: 10px; opacity: 0.9; margin-bottom: 2px; }
  .event-title { font-size: 13px; font-weight: bold; display: block; }
  .event-teacher { font-size: 11px; margin-top: 2px; }

  @media (max-width: 768px) { #smart-input-panel { width: 90%; right: 5%; top: 10px; } }
</style>
</head>
<body>

  <div id="custom-menu">
    <div class="menu-item" onclick="handleAction('toggleSelect')">âœ… é¸å– / å–æ¶ˆ</div>
    <div class="menu-item" onclick="handleAction('editName')">âœï¸ ä¿®æ”¹å­¸ç”Ÿå</div>
    <div class="menu-item" onclick="handleAction('editTeacher')">ğŸ‘¤ ä¿®æ”¹è€å¸«å</div>
    <div class="menu-item" onclick="handleAction('copy')">ğŸ“‹ è¤‡è£½èª²å ‚</div>
    <div class="menu-item" style="color:red;" onclick="handleAction('delete')">ğŸ—‘ï¸ åˆªé™¤ (å«é¸ä¸­)</div>
  </div>

  <div id="smart-input-panel">
    <div id="panel-header"><span>é›²ç«¯æ’èª²åŠ©æ‰‹</span><button id="toggle-btn" style="cursor:pointer; background:none; border:none; color:white;">æ”¶èµ·</button></div>
    <div id="panel-content">
      <textarea id="ai-text-input" placeholder="åœ¨æ­¤è²¼ä¸Šè¨Šæ¯å…§å®¹..."></textarea>
      <button id="parse-btn">è§£æä¸¦åŒæ­¥è‡³é›²ç«¯</button>
    </div>
  </div>

  <div id='calendar'></div>
  
document.getElementById('toggle-btn').onclick = function() {
    const content = document.getElementById('panel-content');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        this.innerText = 'æ”¶èµ·';
    } else {
        content.style.display = 'none';
        this.innerText = 'å±•é–‹';
    }
};
  
<script>
  // åœ¨ä½ çš„ script æ¨™ç±¤å…§åŠ å…¥ä»¥ä¸‹é‚è¼¯
const panel = document.getElementById('smart-input-panel');
const header = document.getElementById('panel-header');

let isDragging = false;
let currentX;
let currentY;
let initialX;
let initialY;
let xOffset = 0;
let yOffset = 0;

header.addEventListener('mousedown', dragStart);
document.addEventListener('mousemove', drag);
document.addEventListener('mouseup', dragEnd);

function dragStart(e) {
    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;
    if (e.target === header || header.contains(e.target)) {
        isDragging = true;
    }
}

function drag(e) {
    if (isDragging) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        xOffset = currentX;
        yOffset = currentY;
        setTranslate(currentX, currentY, panel);
    }
}

function setTranslate(xPos, yPos, el) {
    el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
}

function dragEnd() {
    initialX = currentX;
    initialY = currentY;
    isDragging = false;
}
    const firebaseConfig = {
      apiKey: "AIzaSyAFPtHLY-LqLnDiKUot0mpAPchrC7iqAXg",
      authDomain: "lckroomtable.firebaseapp.com",
      databaseURL: "https://lckroomtable-default-rtdb.firebaseio.com",
      projectId: "lckroomtable",
      storageBucket: "lckroomtable.firebasestorage.app",
      messagingSenderId: "934661729012",
      appId: "1:934661729012:web:14b19af989cd72b2370ca1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const eventRef = db.ref('bookings');

    let copiedEventsBatch = []; 
    let selectedEventInfo = null; 
    let multiSelectIds = new Set(); 

    function getEvId(ev) {
      return ev.startStr + "_" + ev.title + "_" + (ev.getResources()[0]?.id || "");
    }

    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'resourceTimeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'resourceTimeGridDay,resourceTimeGridWeek'
        },
        locale: 'zh-tw',
        schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
        
        // ğŸ”´ é—œéµä¿®æ­£ï¼šå°‡æˆ¿é–“ç½®æ–¼æ—¥æœŸä¹‹ä¸‹ (5é–“æˆ¿é–“ä¸¦åˆ—)
        datesAboveResources: true, 
        
dayHeaderContent: function(arg) {
        const date = arg.date;
        const dayName = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][date.getDay()];
        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
        return { 
          html: `<div style="font-weight:bold; font-size:15px; color:#1e293b;">${dateStr}</div>
                 <div style="font-size:12px; color:#64748b;">(${dayName})</div>` 
        };
    },

        // ğŸŸ¢ æ™‚é–“è»¸å„ªåŒ– (å°é½Šåœ–ç‰‡æ¨£å¼)
        slotDuration: '00:15:00',
        slotLabelInterval: '00:15:00',
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        allDaySlot: false,
slotLabelContent: function(arg) {
        const hour = arg.date.getHours();
        const min = arg.date.getMinutes();
        const ampm = hour >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
        let displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
        
        if (min === 0) {
            // æ•´é»é¡¯ç¤ºï¼šä¸Šåˆ8æ™‚
            return { html: `<div class="hour-label" style="font-weight:bold;">${ampm}${displayHour}æ™‚</div>` };
        } else {
            // åˆ»åº¦é¡¯ç¤ºï¼šä¸Šåˆ8:15
            return { html: `<div class="minute-label" style="font-size:11px; color:#94a3b8; opacity:0.8;">${ampm}${displayHour}:${min.toString().padStart(2, '0')}</div>` };
        }
    },
        editable: true,
        selectable: true,
        
        eventContent: function(arg) {
          const isSelected = multiSelectIds.has(getEvId(arg.event));
          const extraClass = isSelected ? 'event-selected-style' : '';
          return { 
            html: `<div class="event-inner ${extraClass}" style="background-color: ${arg.event.backgroundColor}">
                    <div class="event-time">${arg.timeText}</div>
                    <div class="event-title">${arg.event.title}</div>
                    <div class="event-teacher">ğŸ‘¤ ${arg.event.extendedProps.teacher || ''}</div>
                   </div>` 
          };
        },

        eventChange: () => updateToCloud(),
        eventRemove: () => updateToCloud(),

        select: function(info) {
          if (copiedEventsBatch.length > 0) {
            if (confirm(`è²¼ä¸Šå·²è¤‡è£½çš„ ${copiedEventsBatch.length} å ‚èª²ï¼Ÿ`)) {
              const baseTime = info.start;
              copiedEventsBatch.forEach(data => {
                calendar.addEvent({
                  ...data,
                  start: new Date(baseTime.getTime() + data.offset),
                  end: new Date(baseTime.getTime() + data.offset + data.duration),
                  resourceId: info.resource ? info.resource.id : data.resourceId
                });
              });
              updateToCloud();
              calendar.unselect();
              return;
            }
          }
          const title = prompt('å­¸ç”Ÿå§“åï¼š');
          if (title) {
            const teacher = prompt('å°å¸«å§“åï¼š', 'ä»¥ç³è€å¸«');
            calendar.addEvent({
              title: title, start: info.startStr, end: info.endStr,
              resourceId: info.resource.id, extendedProps: { teacher: teacher || 'ä»¥ç³è€å¸«' },
              backgroundColor: (teacher && teacher !== 'ä»¥ç³è€å¸«') ? '#10b981' : '#6366f1'
            });
            updateToCloud();
          }
          calendar.unselect();
        },

        eventClick: function(info) {
          info.jsEvent.preventDefault();
          selectedEventInfo = info.event;
          const menu = document.getElementById('custom-menu');
          menu.style.display = 'block';
          menu.style.left = info.jsEvent.clientX + 'px';
          menu.style.top = info.jsEvent.clientY + 'px';
          
          const closeMenu = (e) => { 
            if(!menu.contains(e.target)) { 
              menu.style.display = 'none'; 
              document.removeEventListener('mousedown', closeMenu); 
            } 
          };
          setTimeout(() => document.addEventListener('mousedown', closeMenu), 50);
        },

resources: [
        { id: 'R1', title: 'èª ä¿¡å¤§å»³' }, { id: 'R2', title: 'èª ä¿¡ç´°æˆ¿' },
        { id: 'R3', title: 'å˜‰åRm 18' }, { id: 'R4', title: 'å˜‰åRm 12' }, { id: 'R5', title: 'å…¶ä»–' }
    ],
      });

      // åŠŸèƒ½æ§åˆ¶
      window.handleAction = function(action) {
        if (!selectedEventInfo) return;
        const evId = getEvId(selectedEventInfo);

        if (action === 'toggleSelect') {
          multiSelectIds.has(evId) ? multiSelectIds.delete(evId) : multiSelectIds.add(evId);
          calendar.render();
        } else if (action === 'copy') {
          const isMulti = multiSelectIds.has(evId);
          const targets = isMulti ? calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e))) : [selectedEventInfo];
          targets.sort((a,b) => a.start - b.start);
          const startRef = targets[0].start;
          copiedEventsBatch = targets.map(ev => ({
            title: ev.title, offset: ev.start - startRef, duration: ev.end - ev.start,
            resourceId: ev.getResources()[0]?.id, extendedProps: {...ev.extendedProps},
            backgroundColor: ev.backgroundColor
          }));
          alert(`å·²è¤‡è£½ ${targets.length} å ‚èª²`);
          multiSelectIds.clear();
          calendar.render();
        } else if (action === 'delete') {
          const isMulti = multiSelectIds.has(evId);
          const targets = isMulti ? calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e))) : [selectedEventInfo];
          if (confirm(`ç¢ºå®šåˆªé™¤é€™ ${targets.length} å ‚èª²ï¼Ÿ`)) {
            targets.forEach(e => e.remove());
            multiSelectIds.clear();
            updateToCloud();
          }
        }
        document.getElementById('custom-menu').style.display = 'none';
      };

      // é›²ç«¯åŒæ­¥
      eventRef.on('value', (snap) => {
        calendar.removeAllEvents();
        calendar.addEventSource(snap.val() || []);
      });

      function updateToCloud() {
        const events = calendar.getEvents().map(e => ({
          title: e.title, start: e.startStr, end: e.endStr,
          resourceId: e.getResources()[0]?.id,
          extendedProps: e.extendedProps,
          backgroundColor: e.backgroundColor || '#6366f1'
        }));
        eventRef.set(events);
      }

      // AI è§£æ
      document.getElementById('parse-btn').onclick = function() {
        const text = document.getElementById('ai-text-input').value;
        if (!text) return;
        const nameMatch = text.match(/([^\s\n\d,ï¼Œ.]{2,4})(?=[å·²å·³]ç¹³|åŒå­¸|å…ˆç”Ÿ|å°å§|å­¸è²»)/);
        const name = nameMatch ? nameMatch[1] : "æ–°å­¸ç”Ÿ";
        const dateMatches = text.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/g);
        const timeMatch = text.match(/(\d{1,2}[:ï¼š]\d{2})[-â€“â€”](\d{1,2}[:ï¼š]\d{2})/);
        if (dateMatches && timeMatch) {
          const startT = timeMatch[1].replace('ï¼š', ':');
          const endT = timeMatch[2].replace('ï¼š', ':');
          dateMatches.forEach(dStr => {
            const m = dStr.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/);
            calendar.addEvent({
              title: name,
              start: `${new Date().getFullYear()}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${startT.padStart(5,'0')}:00`,
              end: `${new Date().getFullYear()}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${endT.padStart(5,'0')}:00`,
              resourceId: text.includes('å¤§å»³')?'R1':(text.includes('ç´°æˆ¿')?'R2':'R5'),
              extendedProps: { teacher: 'ä»¥ç³è€å¸«' },
              backgroundColor: '#6366f1'
            });
          });
          updateToCloud();
          document.getElementById('ai-text-input').value = "";
        }
      };

      calendar.render();
    });
</script>
</body>
</html>
