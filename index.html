<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  <meta charset='utf-8' />
Â  <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
Â  body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; overflow: hidden; }
Â Â 
Â  /* é¢æ¿é¢¨æ ¼ä¿æŒåœ–ç‰‡ä¸­çš„è—ç´«è‰²ç³» */
Â  #smart-input-panel {
Â  Â  position: fixed; top: 20px; right: 20px; width: 320px; z-index: 999;
Â  Â  background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
Â  Â  border: 1px solid #e2e8f0; overflow: hidden;
Â  }
Â  #panel-header { background: #6366f1; color: white; padding: 10px 15px; cursor: move; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
Â  #panel-content { padding: 15px; }
Â  #ai-text-input { width: 100%; height: 100px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; resize: none; margin-bottom: 10px; }
Â  #parse-btn { background: #6366f1; color: white; border: none; width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
Â Â 
Â  #calendar { max-width: 100%; height: 100vh; background: #fff; padding: 10px; }

Â  /* è‡ªå®šç¾©é¸å–®æ¨£å¼ */
Â  #custom-menu {
Â  Â  display: none; position: fixed; z-index: 10000;
Â  Â  background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
Â  Â  width: 180px; border: 1px solid #e2e8f0; overflow: hidden;
Â  }
Â  .menu-item { padding: 12px 15px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
Â  .menu-item:hover { background: #f8fafc; }
Â Â 
Â  /* åœ–ç‰‡ä¸­çš„æ™‚é–“æ¨™ç±¤é¢¨æ ¼ */
Â  .hour-label { font-weight: bold; color: #1e293b; font-size: 14px; }
Â  .minute-label { font-size: 11px; color: #94a3b8; }

Â  /* é¸ä¸­ç‹€æ…‹ï¼šé‡‘è‰²å¤–æ¡† */
Â  .event-selected-style {
Â  Â  border: 3px solid #facc15 !important;
Â  Â  box-shadow: 0 0 10px rgba(250, 204, 21, 0.8) !important;
Â  Â  z-index: 100 !important;
Â  }

Â  .event-inner { padding: 2px; color: white; line-height: 1.2; height: 100%; }
Â  .event-time { font-size: 10px; opacity: 0.9; margin-bottom: 2px; }
Â  .event-title { font-size: 13px; font-weight: bold; }
</style>
</head>
<body>

Â  <div id="custom-menu">
Â  Â  <div class="menu-item" onclick="handleAction('toggleSelect')">âœ… é¸å– / å–æ¶ˆ</div>
Â  Â  <div class="menu-item" onclick="handleAction('editName')">âœï¸ ä¿®æ”¹å­¸ç”Ÿå</div>
Â  Â  <div class="menu-item" onclick="handleAction('editTeacher')">ğŸ‘¤ ä¿®æ”¹è€å¸«å</div>
Â  Â  <div class="menu-item" onclick="handleAction('copy')">ğŸ“‹ è¤‡è£½ (å«å¤šé¸)</div>
Â  Â  <div class="menu-item" style="color:red;" onclick="handleAction('delete')">ğŸ—‘ï¸ åˆªé™¤ (å«å¤šé¸)</div>
Â  </div>

Â  <div id="smart-input-panel">
Â  Â  <div id="panel-header"><span>é›²ç«¯æ’èª²åŠ©æ‰‹</span><button id="toggle-btn" style="cursor:pointer; background:none; border:none; color:white;">æ”¶èµ·</button></div>
Â  Â  <div id="panel-content">
Â  Â  Â  <textarea id="ai-text-input" placeholder="åœ¨æ­¤è²¼ä¸Šè¨Šæ¯å…§å®¹..."></textarea>
Â  Â  Â  <button id="parse-btn">è§£æä¸¦åŒæ­¥è‡³é›²ç«¯</button>
Â  Â  </div>
Â  </div>

Â  <div id='calendar'></div>

<script>
    // --- Firebase é…ç½® ---
    const firebaseConfig = {
      apiKey: "AIzaSyAFPtHLY-LqLnDiKUot0mpAPchrC7iqAXg",
      authDomain: "lckroomtable.firebaseapp.com",
      databaseURL: "https://lckroomtable-default-rtdb.firebaseio.com",
      projectId: "lckroomtable",
      storageBucket: "lckroomtable.firebasestorage.app",
      messagingSenderId: "934661729012",
      appId: "1:934661729012:web:14b19af989cd72b2370ca1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const eventRef = db.ref('bookings');

    let copiedEventsBatch = []; 
    let selectedEventInfo = null; 
    let multiSelectIds = new Set(); 

    // ğŸ¨ é¡è‰²ç®¡ç†ï¼šç¢ºä¿ä¸åŒå°å¸«ä¸åŒè‰²
    const teacherColorMap = {
      'ä»¥ç³è€å¸«': '#6366f1', // è—ç´«è‰² (é è¨­)
      'å…¶ä»–': '#10b981'      // ç¶ è‰²
    };

    function getTeacherColor(name) {
      if (!name) return teacherColorMap['ä»¥ç³è€å¸«'];
      if (teacherColorMap[name]) return teacherColorMap[name];
      // å¦‚æœæ˜¯æ–°è€å¸«ï¼Œéš¨æ©Ÿç”Ÿæˆä¸€å€‹å¥½çœ‹çš„é¡è‰²
      const colors = ['#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4', '#f97316', '#14b8a6'];
      const randomColor = colors[Math.floor(Math.random() * colors.length)];
      teacherColorMap[name] = randomColor;
      return randomColor;
    }

    function getEvId(ev) {
      return ev.startStr + "_" + ev.title + "_" + (ev.getResources()[0]?.id || "");
    }

    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'resourceTimeGridWeek',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'resourceTimeGridDay,resourceTimeGridWeek' },
        buttonText: { today: 'ä»Šå¤©', resourceTimeGridDay: 'æ—¥', resourceTimeGridWeek: 'é€±' },
        locale: 'zh-tw',
        schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
        slotDuration: '00:15:00',
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        allDaySlot: false,
        selectable: true,
        editable: true,

        // ğŸŸ¢ æ¢å¾©ä¹‹å‰çš„æ™‚é–“æ¨™ç±¤é¢¨æ ¼
        slotLabelContent: function(arg) {
          let mins = arg.date.getMinutes();
          let hour = arg.date.getHours();
          let ampm = hour >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
          let displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
          if (mins === 0) return { html: `<div class="hour-label">${ampm}${displayHour}æ™‚</div>` };
          return { html: `<div class="minute-label">${ampm}${displayHour}:${mins}</div>` };
        },

        eventContent: function(arg) {
          const isSelected = multiSelectIds.has(getEvId(arg.event));
          const borderStyle = isSelected ? 'border: 3px solid #facc15; box-shadow: 0 0 8px rgba(250,204,21,0.8);' : '';
          return { 
            html: `<div class="event-inner" style="${borderStyle}">
                    <div class="event-time">${arg.timeText}</div>
                    <div class="event-title">${arg.event.title}</div>
                    <div class="event-teacher">ğŸ‘¤ ${arg.event.extendedProps.teacher || ''}</div>
                   </div>` 
          };
        },

        select: function(info) {
          if (copiedEventsBatch.length > 0) {
            if (confirm(`è²¼ä¸Šå·²è¤‡è£½çš„ ${copiedEventsBatch.length} å ‚èª²ï¼Ÿ`)) {
              copiedEventsBatch.forEach(data => {
                const newStart = new Date(info.start.getTime() + data.offset);
                const newEnd = new Date(newStart.getTime() + data.duration);
                calendar.addEvent({
                  title: data.title, start: newStart, end: newEnd,
                  resourceId: info.resource.id, extendedProps: data.extendedProps,
                  backgroundColor: data.backgroundColor
                });
              });
              updateToCloud(); calendar.unselect(); return;
            }
          }
          var title = prompt('å­¸ç”Ÿå§“åï¼š');
          if (title) {
            var teacher = prompt('å°å¸«å§“åï¼š', 'ä»¥ç³è€å¸«');
            calendar.addEvent({
              title: title, start: info.startStr, end: info.endStr,
              resourceId: info.resource.id, extendedProps: { teacher: teacher || 'ä»¥ç³è€å¸«' },
              backgroundColor: getTeacherColor(teacher)
            });
            updateToCloud();
          }
          calendar.unselect();
        },

        eventClick: function(info) {
          info.jsEvent.preventDefault();
          selectedEventInfo = info.event;
          const menu = document.getElementById('custom-menu');
          menu.style.display = 'block';
          menu.style.left = info.jsEvent.clientX + 'px';
          menu.style.top = info.jsEvent.clientY + 'px';
          const closeMenu = (e) => { if(!menu.contains(e.target)) { menu.style.display = 'none'; document.removeEventListener('mousedown', closeMenu); } };
          setTimeout(() => document.addEventListener('mousedown', closeMenu), 50);
        },

        resources: [
          { id: 'R1', title: 'èª ä¿¡å¤§å»³' }, { id: 'R2', title: 'èª ä¿¡ç´°æˆ¿' },
          { id: 'R3', title: 'å˜‰åRm 18' }, { id: 'R4', title: 'å˜‰åRm 12' }, { id: 'R5', title: 'å…¶ä»–' }
        ]
      });

      // ğŸ”´ ä¿®æ­£ï¼šæ›´å¼·å¤§çš„æ–‡å­—è§£æé‚è¼¯
      document.getElementById('parse-btn').onclick = function() {
        const text = document.getElementById('ai-text-input').value;
        if (!text) return;

        // 1. æå–åå­—ï¼šåŒ¹é… 2-4 å€‹éæ•¸å­—å­—å…ƒï¼Œæˆ–å–ç¬¬ä¸€è¡Œ
        let nameMatch = text.match(/([^\s\n\d,ï¼Œ.]{2,4})(?=[å·²å·³]ç¹³|åŒå­¸|å…ˆç”Ÿ|å°å§|å­¸è²»|èª²ç¨‹)/);
        let name = nameMatch ? nameMatch[1] : text.split('\n')[0].replace(/[^\w\u4e00-\u9fa5]/g, '').substring(0, 4);

        // 2. æå–å°å¸«
        let teacher = "ä»¥ç³è€å¸«";
        const teacherMatch = text.match(/(?:å°å¸«|è€å¸«)\s*[ï½œ|:ï¼š]\s*([^\s\n]+)/);
        if (teacherMatch) teacher = teacherMatch[1].trim();

        // 3. æå–æ—¥æœŸ (æ”¯æ´ 12æœˆ25æ—¥ æˆ– 12/25)
        const dateMatches = text.match(/(\d{1,2})[æœˆ\/](\d{1,2})[æ—¥]?/g);
        // 4. æå–æ™‚é–“ (æ”¯æ´ 14:00-15:00 æˆ– 14ï¼š00~15ï¼š00)
        const timeMatch = text.match(/(\d{1,2}[:ï¼š]\d{2})\s*[-â€“â€”~]\s*(\d{1,2}[:ï¼š]\d{2})/);

        if (dateMatches && timeMatch) {
          const startTime = timeMatch[1].replace('ï¼š', ':');
          const endTime = timeMatch[2].replace('ï¼š', ':');
          let currentYear = new Date().getFullYear();
          let color = getTeacherColor(teacher);
          let successCount = 0;

          dateMatches.forEach(dateStr => {
            const m = dateStr.match(/(\d{1,2})[æœˆ\/](\d{1,2})/);
            let rId = text.includes('å¤§å»³')?'R1':(text.includes('ç´°æˆ¿')?'R2':(text.includes('18')?'R3':(text.includes('12')?'R4':'R5')));
            
            calendar.addEvent({
              title: name,
              start: `${currentYear}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${startTime.padStart(5,'0')}:00`,
              end: `${currentYear}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${endTime.padStart(5,'0')}:00`,
              resourceId: rId, 
              extendedProps: { teacher: teacher }, 
              backgroundColor: color
            });
            successCount++;
          });

          updateToCloud();
          document.getElementById('ai-text-input').value = "";
          alert(`âœ… æˆåŠŸæ–°å¢ ${successCount} å ‚èª²ï¼\nå­¸ç”Ÿï¼š${name}\nå°å¸«ï¼š${teacher}`);
        } else {
          alert("âŒ è§£æå¤±æ•—ï¼è«‹æª¢æŸ¥è¨Šæ¯ä¸­æ˜¯å¦åŒ…å«æ—¥æœŸ(å¦‚: 12æœˆ25æ—¥)èˆ‡æ™‚é–“(å¦‚: 14:00-15:00)");
        }
      };

      // ğŸŸ¡ è™•ç†åŠŸèƒ½å‹•ä½œ
      window.handleAction = function(action) {
        if (!selectedEventInfo) return;
        const evId = getEvId(selectedEventInfo);

        if (action === 'toggleSelect') {
          multiSelectIds.has(evId) ? multiSelectIds.delete(evId) : multiSelectIds.add(evId);
          calendar.render();
        } 
        else if (action === 'copy') {
          const targetEvents = multiSelectIds.has(evId) ? calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e))) : [selectedEventInfo];
          targetEvents.sort((a, b) => a.start - b.start);
          const baseStart = targetEvents[0].start;
          copiedEventsBatch = targetEvents.map(ev => ({
            title: ev.title, offset: ev.start - baseStart, duration: ev.end - ev.start,
            resourceId: ev.getResources()[0]?.id, extendedProps: ev.extendedProps, backgroundColor: ev.backgroundColor
          }));
          alert(`ğŸ“‹ å·²è¤‡è£½ ${copiedEventsBatch.length} å ‚èª²`);
          multiSelectIds.clear(); calendar.render();
        } 
        else if (action === 'editTeacher') {
          const t = prompt('æ–°å°å¸«å§“åï¼š', selectedEventInfo.extendedProps.teacher);
          if (t) {
            const targets = multiSelectIds.has(evId) ? calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e))) : [selectedEventInfo];
            const newColor = getTeacherColor(t);
            targets.forEach(e => {
              e.setExtendedProp('teacher', t);
              e.setProp('backgroundColor', newColor);
            });
            updateToCloud();
          }
        }
        else if (action === 'delete') {
          if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
            const targets = multiSelectIds.has(evId) ? calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e))) : [selectedEventInfo];
            targets.forEach(e => e.remove());
            multiSelectIds.clear(); updateToCloud();
          }
        }
        document.getElementById('custom-menu').style.display = 'none';
      };

      eventRef.on('value', (snapshot) => {
        calendar.removeAllEvents();
        calendar.addEventSource(snapshot.val() || []);
      });

      function updateToCloud() {
        const events = calendar.getEvents().map(e => ({
          title: e.title, start: e.startStr, end: e.endStr,
          resourceId: e.getResources()[0]?.id, extendedProps: e.extendedProps, backgroundColor: e.backgroundColor || '#6366f1'
        }));
        eventRef.set(events);
      }

      // é¢æ¿æ‹–å‹•èˆ‡ç¸®æ”¾
      const panel = document.getElementById('smart-input-panel');
      const header = document.getElementById('panel-header');
      const toggleBtn = document.getElementById('toggle-btn');
      header.onmousedown = (e) => { 
        if(e.target===toggleBtn) return;
        let ox = panel.offsetLeft - e.clientX, oy = panel.offsetTop - e.clientY;
        document.onmousemove = (e) => { panel.style.left = (e.clientX+ox)+'px'; panel.style.top = (e.clientY+oy)+'px'; panel.style.right='auto'; };
        document.onmouseup = () => document.onmousemove = null;
      };
      toggleBtn.onclick = () => {
        const content = document.getElementById('panel-content');
        content.style.display = content.style.display==='none'?'block':'none';
        toggleBtn.innerText = content.style.display==='none'?'å±•é–‹':'æ”¶èµ·';
      };

      calendar.render();
    });
  </script>
</body>
</html>
