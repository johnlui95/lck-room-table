<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset='utf-8' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
  body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; }
  #smart-input-panel {
    position: fixed; top: 20px; right: 20px; width: 320px; z-index: 999;
    background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 1px solid #e2e8f0;
  }
  #panel-header { background: #6366f1; color: white; padding: 10px 15px; border-radius: 12px 12px 0 0; cursor: move; font-weight: bold; display: flex; justify-content: space-between; }
  #panel-content { padding: 15px; }
  #ai-text-input { width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; resize: none; margin-bottom: 8px; }
  #parse-btn { background: #6366f1; color: white; border: none; width: 100%; padding: 8px; border-radius: 6px; cursor: pointer; }
  
  /* åœ–ç‰‡é¢¨æ ¼è‡ªå®šç¾© */
  .fc-timegrid-slot-label { vertical-align: middle !important; }
  .hour-label { font-weight: bold; color: #333; font-size: 14px; }
  .minute-label { font-size: 12px; color: #666; }
  .header-date { font-size: 16px; font-weight: bold; }
  .header-day { font-size: 14px; color: #444; }

  #custom-menu { display: none; position: fixed; z-index: 10000; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 160px; border: 1px solid #eee; }
  .menu-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
  .menu-item:hover { background: #f0f0f0; }
</style>
</head>
<body>

  <div id="custom-menu">
    <div class="menu-item" onclick="handleAction('toggleSelect')">âœ… é¸å– / å–æ¶ˆ</div>
    <div class="menu-item" onclick="handleAction('editName')">âœï¸ ä¿®æ”¹å­¸ç”Ÿå</div>
    <div class="menu-item" onclick="handleAction('editTeacher')">ğŸ‘¤ ä¿®æ”¹è€å¸«å</div>
    <div class="menu-item" onclick="handleAction('copy')">ğŸ“‹ è¤‡è£½ (å«å¤šé¸)</div>
    <div class="menu-item" style="color:red;" onclick="handleAction('delete')">ğŸ—‘ï¸ åˆªé™¤ (å«å¤šé¸)</div>
  </div>

  <div id="smart-input-panel">
    <div id="panel-header"><span>é›²ç«¯æ’èª²åŠ©æ‰‹</span><button id="toggle-btn" style="background:none; border:none; color:white; cursor:pointer;">æ”¶èµ·</button></div>
    <div id="panel-content">
      <textarea id="ai-text-input" placeholder="è²¼ä¸Šè¨Šæ¯å…§å®¹..."></textarea>
      <button id="parse-btn">è§£æä¸¦åŒæ­¥è‡³é›²ç«¯</button>
    </div>
  </div>

  <div id='calendar'></div>

 <script>
    // --- Firebase ä¿æŒä¸è®Š ---
    const firebaseConfig = {
      apiKey: "AIzaSyAFPtHLY-LqLnDiKUot0mpAPchrC7iqAXg",
      authDomain: "lckroomtable.firebaseapp.com",
      databaseURL: "https://lckroomtable-default-rtdb.firebaseio.com",
      projectId: "lckroomtable",
      storageBucket: "lckroomtable.firebasestorage.app",
      messagingSenderId: "934661729012",
      appId: "1:934661729012:web:14b19af989cd72b2370ca1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const eventRef = db.ref('bookings');

    let multiSelectIds = new Set();
    let copiedEventsBatch = [];
    let selectedEventInfo = null;

    // ğŸ¨ è€å¸«é¡è‰²åº«
    const colors = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4'];
    const teacherMap = {};

    function getTeacherColor(name) {
      if (!name || name === 'ä»¥ç³è€å¸«') return colors[0];
      if (!teacherMap[name]) teacherMap[name] = colors[Object.keys(teacherMap).length % colors.length + 1] || '#14b8a6';
      return teacherMap[name];
    }

    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'resourceTimeGridWeek',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'resourceTimeGridDay,resourceTimeGridWeek' },
        locale: 'zh-tw',
        firstDay: 0,
        schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
        
        // ğŸŸ¢ ä¿®æ­£ï¼šé™åˆ¶æ™‚é–“é¡¯ç¤ºç¯„åœ (08:00 - 22:00)
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        
        slotDuration: '00:15:00',
        slotLabelInterval: '00:15:00',
        allDaySlot: false,
        editable: true,

        dayHeaderContent: function(arg) {
          const date = arg.date;
          const mm = date.getMonth() + 1;
          const dd = date.getDate();
          const dayName = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][date.getDay()];
          return { html: `<div class="header-date">${mm}/${dd}</div><div class="header-day">(${dayName})</div>` };
        },

        // ğŸŸ¢ ä¿®æ­£ï¼šå›å¾©ç°¡ç´„é¢¨æ ¼çš„æ™‚é–“æ¨™ç±¤ (ä¾æ“šæ‚¨çš„åœ–ç‰‡æ¨£å¼)
        slotLabelContent: function(arg) {
          const date = arg.date;
          const hour = date.getHours();
          const min = date.getMinutes();
          const ampm = hour >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
          const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
          
          if (min === 0) {
            return { html: `<div class="hour-label">${ampm}${displayHour}æ™‚</div>` };
          }
          return { html: `<div class="minute-label">${ampm}${displayHour}:${String(min).padStart(2, '0')}</div>` };
        },

        eventContent: function(arg) {
          const isSelected = multiSelectIds.has(arg.event.startStr + "_" + arg.event.title);
          const style = isSelected ? 'border: 3px solid #facc15;' : '';
          return { html: `<div class="event-inner" style="${style}"><div class="event-time">${arg.timeText}</div><div class="event-title">${arg.event.title}</div><div style="font-size:10px; opacity:0.8;">ğŸ‘¤ ${arg.event.extendedProps.teacher || ''}</div></div>` };
        },

        resources: [{ id: 'R1', title: 'èª ä¿¡å¤§å»³' }, { id: 'R2', title: 'èª ä¿¡ç´°æˆ¿' }, { id: 'R3', title: 'å˜‰åRm 18' }, { id: 'R4', title: 'å˜‰åRm 12' }, { id: 'R5', title: 'å…¶ä»–' }],
        
        eventClick: function(info) {
          selectedEventInfo = info.event;
          const menu = document.getElementById('custom-menu');
          menu.style.display = 'block';
          menu.style.left = info.jsEvent.clientX + 'px';
          menu.style.top = info.jsEvent.clientY + 'px';
        }
      });

      // ğŸ”´ æ–‡å­—è§£æèˆ‡åŒæ­¥é‚è¼¯ä¿æŒä¸è®Š
      document.getElementById('parse-btn').onclick = function() {
        const text = document.getElementById('ai-text-input').value.trim();
        if (!text) return;
        let name = text.split('\n')[0].replace(/[^\u4e00-\u9fa5a-zA-Z]/g, '').substring(0,4);
        let teacher = "ä»¥ç³è€å¸«";
        const tMatch = text.match(/(?:è€å¸«|å°å¸«)[:ï¼š\s]*([^\s\n]+)/);
        if (tMatch) teacher = tMatch[1];
        const dateMatch = text.match(/(\d{1,2})[æœˆ\/](\d{1,2})/g);
        const timeMatch = text.match(/(\d{1,2}[:ï¼š]\d{2})\s*[-~â€“â€”]\s*(\d{1,2}[:ï¼š]\d{2})/);

        if (dateMatch && timeMatch) {
          const startT = timeMatch[1].replace('ï¼š', ':');
          const endT = timeMatch[2].replace('ï¼š', ':');
          const year = new Date().getFullYear();
          const bgColor = getTeacherColor(teacher);
          dateMatch.forEach(dStr => {
            const d = dStr.match(/(\d{1,2})[æœˆ\/](\d{1,2})/);
            calendar.addEvent({
              title: name,
              start: `${year}-${d[1].padStart(2,'0')}-${d[2].padStart(2,'0')}T${startT.padStart(5,'0')}:00`,
              end: `${year}-${d[1].padStart(2,'0')}-${d[2].padStart(2,'0')}T${endT.padStart(5,'0')}:00`,
              resourceId: text.includes('å¤§å»³') ? 'R1' : (text.includes('ç´°æˆ¿') ? 'R2' : 'R5'),
              extendedProps: { teacher: teacher },
              backgroundColor: bgColor
            });
          });
          updateToCloud(calendar);
          alert(`æˆåŠŸè§£æä¸¦æ–°å¢èª²ç¨‹ï¼`);
        } else {
          alert("ç„¡æ³•è§£ææ—¥æœŸæˆ–æ™‚é–“ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚");
        }
      };

      function updateToCloud(cal) {
        const evs = cal.getEvents().map(e => ({
          title: e.title, start: e.startStr, end: e.endStr, resourceId: e.getResources()[0]?.id,
          extendedProps: e.extendedProps, backgroundColor: e.backgroundColor
        }));
        eventRef.set(evs);
      }

      eventRef.on('value', snap => {
        calendar.removeAllEvents();
        calendar.addEventSource(snap.val() || []);
      });

      document.addEventListener('mousedown', (e) => { if (!e.target.closest('#custom-menu')) document.getElementById('custom-menu').style.display = 'none'; });
      calendar.render();
    });

    window.handleAction = function(act) {
      if (!selectedEventInfo) return;
      if (act === 'delete') { selectedEventInfo.remove(); }
      document.getElementById('custom-menu').style.display = 'none';
    };
  </script>
</body>
</html>
