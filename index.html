<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset='utf-8' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
  body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; overflow: hidden; }

/* å¼·åˆ¶é–‹å•Ÿè·¨æ¬„ä½é¸å–æ„Ÿæ‡‰ */
.fc-timegrid-cols table {
    pointer-events: all !important;
}

/* è®“æ‹–æ›³æ™‚çš„è—è‰²æ–¹æ¡†å¯ä»¥é¡¯ç¤ºåœ¨æœ€å‰é¢ */
.fc-highlight {
    z-index: 5 !important;
    background: rgba(99, 102, 241, 0.2) !important;
    border: 2px dashed #6366f1 !important;
}

/* ç¢ºä¿æˆ¿é–“æ¨™é¡Œä¸æœƒé®æ“‹æ»‘é¼  */
.fc-col-header-cell {
    pointer-events: auto !important;
}
  
#smart-input-panel {
    position: fixed; 
    top: 20px; 
    left: auto; 
    right: 20px; /* é è¨­é å³ */
    width: 320px; 
    z-index: 9999; /* ç¢ºä¿åœ¨æ—¥æ›†ä¹‹ä¸Š */
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    border: 1px solid #e2e8f0; 
    overflow: hidden;
    touch-action: none; /* é˜²æ­¢ç§»å‹•ç«¯å¹²æ“¾ */
}

#panel-header { 
    background: #6366f1; 
    color: white; 
    padding: 10px 15px; 
    cursor: grab; /* æç¤ºå¯æŠ“å– */
    font-weight: bold; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
}
#panel-header:active { cursor: grabbing; }
  #panel-content { padding: 15px; }
  #ai-text-input { width: 100%; height: 100px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; resize: vertical; margin-bottom: 10px; }
  #parse-btn { background: #6366f1; color: white; border: none; width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
  
  #calendar { max-width: 100%; height: 100vh; background: #fff; padding: 10px; box-sizing: border-box; }

  #custom-menu {
    display: none; position: fixed; z-index: 10000;
    background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    width: 180px; border: 1px solid #e2e8f0; overflow: hidden;
  }
  .menu-item { padding: 12px 15px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
  .menu-item:hover { background: #f8fafc; }
  
  /* é¸ä¸­ç‹€æ…‹çš„è¦–è¦ºæ•ˆæœ */
  .event-selected-style {
    border: 3px solid #facc15 !important;
    box-shadow: 0 0 12px rgba(250, 204, 21, 0.9) !important;
  }

  .hour-label { font-weight: bold; color: #1e293b; font-size: 13px; }
  .minute-label { font-size: 11px; color: #94a3b8; }
  .event-inner { padding: 4px; color: white; line-height: 1.2; height: 100%; border-radius: 4px; box-sizing: border-box; }
  .event-time { font-size: 10px; opacity: 0.9; margin-bottom: 2px; }
  .event-title { font-size: 13px; font-weight: bold; display: block; }
  .event-teacher { font-size: 11px; margin-top: 2px; }

  @media (max-width: 768px) { #smart-input-panel { width: 90%; right: 5%; top: 10px; } }
</style>
</head>
<body>

<div id="custom-menu" style="display:none; position:fixed; z-index:9999; background:white; border:1px solid #ccc; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden;">
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; font-weight: bold; background: #f9fafb;" onclick="handleAction('toggleSelect')">ğŸ”² å–æ¶ˆé¸å–æ­¤èª²å ‚</div>
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="handleAction('editName')">âœï¸ ä¿®æ”¹å­¸ç”Ÿå</div>
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="handleAction('editTeacher')">ğŸ‘©â€ğŸ« ä¿®æ”¹è€å¸«å</div>
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #6366f1;" onclick="handleAction('copy')">ğŸ“‹ Copy é¸ä¸­èª²å ‚</div>
    <div style="padding: 10px 15px; cursor: pointer; color: red;" onclick="handleAction('delete')">ğŸ—‘ï¸ åˆªé™¤é¸ä¸­èª²å ‚</div>
</div>

  <div id="smart-input-panel">
    <div id="panel-header"><span>é›²ç«¯æ’èª²åŠ©æ‰‹</span><button id="toggle-btn" style="cursor:pointer; background:none; border:none; color:white;">æ”¶èµ·</button></div>
    <div id="panel-content">
      <textarea id="ai-text-input" placeholder="åœ¨æ­¤è²¼ä¸Šè¨Šæ¯å…§å®¹..."></textarea>
      <button id="parse-btn">è§£æä¸¦åŒæ­¥è‡³é›²ç«¯</button>
    </div>
  </div>

  <div id='calendar'></div>
  
  <script>
// --- 1. æ ¸å¿ƒè®Šæ•¸èˆ‡ Firebase é…ç½® ---
const firebaseConfig = {
    apiKey: "AIzaSyAFPtHLY-LqLnDiKUot0mpAPchrC7iqAXg",
    authDomain: "lckroomtable.firebaseapp.com",
    databaseURL: "https://lckroomtable-default-rtdb.firebaseio.com",
    projectId: "lckroomtable",
    storageBucket: "lckroomtable.firebasestorage.app",
    messagingSenderId: "934661729012",
    appId: "1:934661729012:web:14b19af989cd72b2370ca1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const eventRef = db.ref('bookings');

let calendar, selectedEventInfo, copiedEventsBatch = [], multiSelectIds = new Set();

// è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿå”¯ä¸€ ID
const getEvId = (ev) => ev.startStr + "_" + ev.title + "_" + (ev.getResources()[0]?.id || "");

// è¼”åŠ©å‡½å¼ï¼šåŒæ­¥åˆ°é›²ç«¯
const updateToCloud = () => {
    if (!calendar) return;
    const events = calendar.getEvents().map(e => ({
        title: e.title, start: e.startStr, end: e.endStr,
        resourceId: e.getResources()[0]?.id, extendedProps: e.extendedProps,
        backgroundColor: e.backgroundColor || '#6366f1'
    }));
    eventRef.set(events);
};

// è¼”åŠ©å‡½å¼ï¼šå½ˆå‡ºå³éµé¸å–®
function showCustomMenu(info) {
    selectedEventInfo = info.event;
    const menu = document.getElementById('custom-menu');
    menu.style.display = 'block';
    menu.style.left = info.jsEvent.clientX + 'px';
    menu.style.top = info.jsEvent.clientY + 'px';
    const closeMenu = (e) => { if(!menu.contains(e.target)) { menu.style.display = 'none'; document.removeEventListener('mousedown', closeMenu); } };
    setTimeout(() => document.addEventListener('mousedown', closeMenu), 50);
}

// --- 2. é¸å–®æŒ‰éˆ•åŠŸèƒ½æ§åˆ¶ ---
window.handleAction = function(action) {
    if (!selectedEventInfo) return;
    const ev = selectedEventInfo;
    const evId = getEvId(ev);

    if (action === 'toggleSelect') multiSelectIds.delete(evId);
    if (action === 'editName') { const n = prompt('ä¿®æ”¹å­¸ç”Ÿåï¼š', ev.title); if(n) ev.setProp('title', n); }
    if (action === 'editTeacher') { 
        const t = prompt('ä¿®æ”¹è€å¸«ï¼š', ev.extendedProps.teacher); 
        if(t) { 
            ev.setExtendedProp('teacher', t); 
            ev.setProp('backgroundColor', t.includes('JK') ? '#10b981' : '#6366f1'); 
        } 
    }
    if (action === 'copy') {
        const targets = calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e)));
        const finalT = targets.length > 0 ? targets : [ev];
        finalT.sort((a, b) => a.start - b.start);
        const ref = finalT[0].start;
        copiedEventsBatch = finalT.map(e => ({
            title: e.title, offset: e.start - ref, duration: e.end - e.start,
            extendedProps: {...e.extendedProps}, backgroundColor: e.backgroundColor
        }));
        alert(`å·²è¤‡è£½ ${finalT.length} å ‚èª²ï¼Œé»æ“Šç©ºç™½è™•å¯è²¼ä¸Šã€‚`);
        multiSelectIds.clear();
    }
    if (action === 'delete') {
        const delT = calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e)));
        const finalD = delT.length > 0 ? delT : [ev];
        if (confirm(`åˆªé™¤ ${finalD.length} å ‚èª²ï¼Ÿ`)) finalD.forEach(e => e.remove());
        multiSelectIds.clear();
    }
    updateToCloud();
    calendar.render();
    document.getElementById('custom-menu').style.display = 'none';
};

// --- 3. åˆå§‹åŒ–æ—¥æ›† ---
document.addEventListener('DOMContentLoaded', function() {
calendar = new FullCalendar.Calendar(calendarEl, {
    // 1. ç¢ºä¿åˆå§‹è¦–åœ–åç¨±æ­£ç¢º
    initialView: 'resourceTimeGridWeek', 
    
    // 2. ä¿®æ­£ä¸Šæ–¹å·¥å…·æ¬„æŒ‰éˆ• (right éƒ¨åˆ†)
    headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'resourceTimeGridDay,resourceTimeGridWeek' // å¿…é ˆåŒ…å«é€™å…©å€‹åç¨±æ‰æœ‰æŒ‰éˆ•
    },

    locale: 'zh-tw',
    schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
    
    // 3. é—œéµï¼šæˆ¿é–“åœ¨æ—¥æœŸä¹‹ä¸‹
    datesAboveResources: true, 

    // 4. æ™‚é–“è»¸ç°¡ç´„é¢¨æ ¼ (å°æ™‚èˆ‡åˆ†é˜)
    slotDuration: '00:15:00',
    slotLabelInterval: '00:15:00',
    slotLabelContent: (arg) => {
        const hour = arg.date.getHours();
        const min = arg.date.getMinutes();
        if (min === 0) {
            return { html: `<div style="font-weight:bold; color:#1e293b;">${hour}æ™‚</div>` };
        }
        return { html: `<div style="font-size:11px; color:#94a3b8;">${min}</div>` };
    },

    // 5. æ—¥æœŸæ¨™é ­é¡¯ç¤ºæ–¹å¼
    dayHeaderContent: (arg) => {
        const date = arg.date;
        const days = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'];
        return { 
            html: `<div style="font-weight:bold;">${date.getMonth()+1}/${date.getDate()}</div><div style="font-size:12px;">(${days[date.getDay()]})</div>` 
        };
    },

    resources: [
        { id: 'R1', title: 'èª ä¿¡å¤§å»³' }, 
        { id: 'R2', title: 'èª ä¿¡ç´°æˆ¿' },
        { id: 'R3', title: 'å˜‰åRm 18' }, 
        { id: 'R4', title: 'å˜‰åRm 12' }, 
        { id: 'R5', title: 'å…¶ä»–' }
    ],
        eventContent: (arg) => {
            const isSelected = multiSelectIds.has(getEvId(arg.event));
            return { html: `<div class="event-inner ${isSelected ? 'event-selected-style' : ''}" style="background-color:${arg.event.backgroundColor}">
                <div class="event-time">${arg.timeText}</div>
                <div class="event-title">${arg.event.title}</div>
                <div class="event-teacher">ğŸ‘¤ ${arg.event.extendedProps.teacher || ''}</div>
            </div>` };
        },
        eventClick: function(info) {
            info.jsEvent.preventDefault();
            const id = getEvId(info.event);
            multiSelectIds.has(id) ? showCustomMenu(info) : (multiSelectIds.add(id), calendar.render());
        },
        select: function(info) {
            // é‚è¼¯ A: åŸ·è¡Œè²¼ä¸Š
            if (copiedEventsBatch.length > 0) {
                copiedEventsBatch.forEach(d => {
                    calendar.addEvent({
                        title: d.title, start: new Date(info.start.getTime() + d.offset),
                        end: new Date(info.start.getTime() + d.offset + d.duration),
                        resourceId: info.resource.id, extendedProps: d.extendedProps, backgroundColor: d.backgroundColor
                    });
                });
                updateToCloud();
                copiedEventsBatch = [];
                calendar.unselect();
                return;
            }
            // é‚è¼¯ B: åŸ·è¡Œæ¡†é¸ (æ‹–æ›³è¶…é15åˆ†é˜)
            if ((info.end - info.start) / 60000 > 15) {
                let found = false;
                calendar.getEvents().forEach(ev => {
                    if (ev.start >= info.start && ev.start < info.end) { multiSelectIds.add(getEvId(ev)); found = true; }
                });
                if (found) { calendar.render(); calendar.unselect(); return; }
            }
            // é‚è¼¯ C: æ–°å¢èª²å ‚
            const title = prompt('å­¸ç”Ÿå§“åï¼š');
            if (title) {
                const t = prompt('å°å¸«ï¼š', 'ä»¥ç³è€å¸«');
                calendar.addEvent({
                    title: title, start: info.startStr, end: info.endStr, resourceId: info.resource.id,
                    extendedProps: { teacher: t || 'ä»¥ç³è€å¸«' },
                    backgroundColor: (t && t.includes('JK')) ? '#10b981' : '#6366f1'
                });
                updateToCloud();
            }
            calendar.unselect();
        },
        eventChange: updateToCloud,
        eventRemove: updateToCloud
    });

    // AI è§£æç¶å®š
    document.getElementById('parse-btn').onclick = function() {
        const text = document.getElementById('ai-text-input').value;
        const nameMatch = text.match(/([^\s\n\d,ï¼Œ.]{2,4})(?=[å·²å·³]ç¹³|åŒå­¸|å…ˆç”Ÿ|å°å§|å­¸è²»)/);
        const dateMatch = text.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/g);
        const timeMatch = text.match(/(\d{1,2}[:ï¼š]\d{2})[-â€“â€”](\d{1,2}[:ï¼š]\d{2})/);
        if (dateMatch && timeMatch) {
            const teacherMatch = text.match(/[|ï½œ]\s*(\S+?)(?:è€å¸«)?(?:\n|$|\s)/);
            const teacher = teacherMatch ? (teacherMatch[1].includes('è€å¸«')?teacherMatch[1]:teacherMatch[1]+'è€å¸«') : (text.includes('JK')?'JKè€å¸«':'ä»¥ç³è€å¸«');
            dateMatch.forEach(d => {
                const m = d.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                calendar.addEvent({
                    title: nameMatch ? nameMatch[1] : "æ–°å­¸ç”Ÿ",
                    start: `${new Date().getFullYear()}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${timeMatch[1].replace('ï¼š',':').padStart(5,'0')}:00`,
                    end: `${new Date().getFullYear()}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${timeMatch[2].replace('ï¼š',':').padStart(5,'0')}:00`,
                    resourceId: text.includes('å¤§å»³')?'R1':(text.includes('ç´°æˆ¿')?'R2':(text.includes('18')?'R3':(text.includes('12')?'R4':'R5'))),
                    extendedProps: { teacher: teacher }, backgroundColor: teacher.includes('JK') ? '#10b981' : '#6366f1'
                });
            });
            updateToCloud(); alert("åŒæ­¥æˆåŠŸ");
        }
    };

    // Firebase å¯¦æ™‚åŒæ­¥
    eventRef.on('value', snap => {
        calendar.removeAllEvents();
        if (snap.val()) calendar.addEventSource(Object.values(snap.val()));
    });

    calendar.render();
});

// é¢æ¿æ§åˆ¶
const panel = document.getElementById('smart-input-panel'), header = document.getElementById('panel-header');
let active = false, xOffset = 0, yOffset = 0, initX, initY;
header.onmousedown = (e) => { active = true; initX = e.clientX - xOffset; initY = e.clientY - yOffset; };
document.onmousemove = (e) => { if(active) { xOffset = e.clientX - initX; yOffset = e.clientY - initY; panel.style.transform = `translate(${xOffset}px, ${yOffset}px)`; } };
document.onmouseup = () => active = false;
document.getElementById('toggle-btn').onclick = function() {
    const c = document.getElementById('panel-content');
    c.style.display = (c.style.display === 'none' ? 'block' : 'none');
    this.innerText = (c.style.display === 'none' ? 'å±•é–‹' : 'æ”¶èµ·');
};
    </script>

</body>
</html>
