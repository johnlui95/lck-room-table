<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset='utf-8' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
  body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; overflow: hidden; }

  /* åŸºç¤æ—¥æ›†æ¨£å¼ */
  #calendar { max-width: 100%; height: 100vh; background: #fff; padding: 10px; box-sizing: border-box; }
  
  /* æµ®å‹•é¢æ¿æ¨£å¼ */
  #smart-input-panel {
    position: fixed; top: 20px; right: 20px; width: 320px; z-index: 9999;
    background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    border: 1px solid #e2e8f0; overflow: hidden; touch-action: none;
  }
  #panel-header { background: #6366f1; color: white; padding: 10px 15px; cursor: grab; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
  #panel-content { padding: 15px; }
  #ai-text-input { width: 100%; height: 100px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; resize: vertical; margin-bottom: 10px; }
  #parse-btn { background: #6366f1; color: white; border: none; width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }

  /* è‡ªå®šç¾©å³éµ/é»æ“Šé¸å–® */
  #custom-menu {
    display: none; position: fixed; z-index: 10000;
    background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    width: 180px; border: 1px solid #e2e8f0; overflow: hidden;
  }
  .menu-item { padding: 12px 15px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
  .menu-item:hover { background: #f8fafc; }

  /* é¸ä¸­ç‹€æ…‹çš„è¦–è¦ºæ•ˆæœ (é»ƒæ¡†) */
  .event-selected-style {
    border: 3px solid #facc15 !important;
    box-shadow: 0 0 12px rgba(250, 204, 21, 0.9) !important;
  }

  /* èª²å ‚å…§å®¹æ¨£å¼ */
  .event-inner { padding: 4px; color: white; line-height: 1.2; height: 100%; border-radius: 4px; box-sizing: border-box; }
  .event-time { font-size: 10px; opacity: 0.9; }
  .event-title { font-size: 13px; font-weight: bold; display: block; }
  .event-teacher { font-size: 11px; margin-top: 2px; }
  .hour-label { font-weight: bold; color: #1e293b; }

  @media (max-width: 768px) { #smart-input-panel { width: 90%; right: 5%; } }
</style>
</head>
<body>

  <div id="custom-menu">
    <div class="menu-item" style="font-weight:bold; background:#f9fafb;" onclick="handleAction('toggleSelect')">ğŸ”² å–æ¶ˆé¸å–æ­¤èª²å ‚</div>
    <div class="menu-item" onclick="handleAction('editName')">âœï¸ ä¿®æ”¹å­¸ç”Ÿå</div>
    <div class="menu-item" onclick="handleAction('editTeacher')">ğŸ‘©â€ğŸ« ä¿®æ”¹è€å¸«å</div>
    <div class="menu-item" style="color:#6366f1;" onclick="handleAction('copy')">ğŸ“‹ Copy æ‰€æœ‰é¸ä¸­</div>
    <div class="menu-item" style="color:red;" onclick="handleAction('delete')">ğŸ—‘ï¸ åˆªé™¤æ‰€æœ‰é¸ä¸­</div>
  </div>

  <div id="smart-input-panel">
    <div id="panel-header"><span>é›²ç«¯æ’èª²åŠ©æ‰‹</span><button id="toggle-btn" style="cursor:pointer; background:none; border:none; color:white;">æ”¶èµ·</button></div>
    <div id="panel-content">
      <textarea id="ai-text-input" placeholder="åœ¨æ­¤è²¼ä¸Šè¨Šæ¯å…§å®¹..."></textarea>
      <button id="parse-btn">è§£æä¸¦åŒæ­¥è‡³é›²ç«¯</button>
    </div>
  </div>

  <div id='calendar'></div>

<script>
// --- 1. åˆå§‹åŒ– Firebase ---
const firebaseConfig = {
    apiKey: "AIzaSyAFPtHLY-LqLnDiKUot0mpAPchrC7iqAXg",
    authDomain: "lckroomtable.firebaseapp.com",
    databaseURL: "https://lckroomtable-default-rtdb.firebaseio.com",
    projectId: "lckroomtable",
    storageBucket: "lckroomtable.firebasestorage.app",
    messagingSenderId: "934661729012",
    appId: "1:934661729012:web:14b19af989cd72b2370ca1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const eventRef = db.ref('bookings');

// --- 2. å…¨åŸŸè®Šæ•¸ ---
let calendar;
let copiedEventsBatch = [];
let selectedEventInfo = null;
let multiSelectIds = new Set();

// --- 3. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

function getEvId(ev) {
    return ev.startStr + "_" + ev.title + "_" + (ev.getResources()[0]?.id || "");
}

function updateToCloud() {
    if (!calendar) return;
    const events = calendar.getEvents().map(e => ({
        title: e.title,
        start: e.startStr,
        end: e.endStr,
        resourceId: e.getResources()[0]?.id,
        extendedProps: e.extendedProps,
        backgroundColor: e.backgroundColor || '#6366f1'
    }));
    eventRef.set(events);
}

function showCustomMenu(info) {
    selectedEventInfo = info.event;
    const menu = document.getElementById('custom-menu');
    menu.style.display = 'block';
    menu.style.left = info.jsEvent.clientX + 'px';
    menu.style.top = info.jsEvent.clientY + 'px';
    
    const closeMenu = (e) => { 
        if(!menu.contains(e.target)) { 
            menu.style.display = 'none'; 
            document.removeEventListener('mousedown', closeMenu); 
        } 
    };
    setTimeout(() => document.addEventListener('mousedown', closeMenu), 50);
}

window.handleAction = function(action) {
    if (!selectedEventInfo) return;
    const ev = selectedEventInfo;
    const evId = getEvId(ev);

    switch (action) {
        case 'toggleSelect':
            multiSelectIds.delete(evId);
            break;
        case 'editName':
            const newName = prompt('ä¿®æ”¹å­¸ç”Ÿå§“åï¼š', ev.title);
            if (newName) ev.setProp('title', newName);
            break;
        case 'editTeacher':
            const newTeacher = prompt('ä¿®æ”¹å°å¸«å§“åï¼š', ev.extendedProps.teacher);
            if (newTeacher) {
                ev.setExtendedProp('teacher', newTeacher);
                ev.setProp('backgroundColor', newTeacher.includes('JK') ? '#10b981' : '#6366f1');
            }
            break;
        case 'copy':
            const targets = calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e)));
            const finalTargets = targets.length > 0 ? targets : [ev];
            finalTargets.sort((a, b) => a.start - b.start);
            const startRef = finalTargets[0].start;
            copiedEventsBatch = finalTargets.map(e => ({
                title: e.title, offset: e.start - startRef, duration: e.end - e.start,
                extendedProps: {...e.extendedProps}, backgroundColor: e.backgroundColor
            }));
            alert(`å·²è¤‡è£½ ${finalTargets.length} å ‚èª²`);
            multiSelectIds.clear();
            break;
        case 'delete':
            const delTargets = calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e)));
            const finalDels = delTargets.length > 0 ? delTargets : [ev];
            if (confirm(`ç¢ºå®šåˆªé™¤é€™ ${finalDels.length} å ‚èª²ï¼Ÿ`)) {
                finalDels.forEach(e => e.remove());
                multiSelectIds.clear();
            }
            break;
    }
    updateToCloud();
    calendar.render();
    document.getElementById('custom-menu').style.display = 'none';
};

// --- 4. åˆå§‹åŒ–æ—¥æ›† ---
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'resourceTimeGridWeek',
        locale: 'zh-tw',
        schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
        datesAboveResources: true,
        editable: true,
        selectable: true,
        slotDuration: '00:15:00',
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        resources: [
            { id: 'R1', title: 'èª ä¿¡å¤§å»³' }, { id: 'R2', title: 'èª ä¿¡ç´°æˆ¿' },
            { id: 'R3', title: 'å˜‰åRm 18' }, { id: 'R4', title: 'å˜‰åRm 12' }, { id: 'R5', title: 'å…¶ä»–' }
        ],
        eventContent: (arg) => {
            const isSelected = multiSelectIds.has(getEvId(arg.event));
            const extraClass = isSelected ? 'event-selected-style' : '';
            return { html: `<div class="event-inner ${extraClass}" style="background-color:${arg.event.backgroundColor}">
                                <div class="event-time">${arg.timeText}</div>
                                <div class="event-title">${arg.event.title}</div>
                                <div class="event-teacher">ğŸ‘¤ ${arg.event.extendedProps.teacher || ''}</div>
                            </div>` };
        },
        eventClick: function(info) {
            info.jsEvent.preventDefault();
            const id = getEvId(info.event);
            if (multiSelectIds.has(id)) {
                showCustomMenu(info);
            } else {
                multiSelectIds.add(id);
                calendar.render();
            }
        },
        select: function(info) {
            // é»æ“Šç©ºç™½è™•æ™‚ï¼šå¦‚æœæ˜¯è²¼ä¸Šæ¨¡å¼å‰‡è²¼ä¸Šï¼Œå¦å‰‡æ¸…ç©ºé¸æ“‡ä¸¦æ–°å¢
            if (copiedEventsBatch.length > 0) {
                if (confirm(`è²¼ä¸Š ${copiedEventsBatch.length} å ‚èª²ï¼Ÿ`)) {
                    copiedEventsBatch.forEach(data => {
                        calendar.addEvent({
                            title: data.title,
                            start: new Date(info.start.getTime() + data.offset),
                            end: new Date(info.start.getTime() + data.offset + data.duration),
                            resourceId: info.resource.id,
                            extendedProps: data.extendedProps,
                            backgroundColor: data.backgroundColor
                        });
                    });
                    updateToCloud();
                }
                copiedEventsBatch = [];
            } else {
                multiSelectIds.clear(); // é»æ“Šç©ºç™½è™•æ¸…ç©ºé»ƒæ¡†
                calendar.render();
                const title = prompt('å­¸ç”Ÿå§“åï¼š');
                if (title) {
                    const teacher = prompt('å°å¸«å§“åï¼š', 'ä»¥ç³è€å¸«');
                    calendar.addEvent({
                        title: title, start: info.startStr, end: info.endStr,
                        resourceId: info.resource.id,
                        extendedProps: { teacher: teacher || 'ä»¥ç³è€å¸«' },
                        backgroundColor: (teacher && teacher.includes('JK')) ? '#10b981' : '#6366f1'
                    });
                    updateToCloud();
                }
            }
            calendar.unselect();
        },
        eventChange: updateToCloud,
        eventRemove: updateToCloud
    });

    // --- 5. AI è§£æé‚è¼¯ ---
    document.getElementById('parse-btn').onclick = function() {
        const text = document.getElementById('ai-text-input').value.trim();
        if (!text) return;
        const name = (text.match(/([^\s\n\d,ï¼Œ.]{2,4})(?=[å·²å·³]ç¹³|åŒå­¸|å…ˆç”Ÿ|å°å§|å­¸è²»)/) || [])[1] || "æ–°å­¸ç”Ÿ";
        const dates = text.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/g);
        const times = text.match(/(\d{1,2}[:ï¼š]\d{2})[-â€“â€”](\d{1,2}[:ï¼š]\d{2})/);
        
        if (dates && times) {
            dates.forEach(dStr => {
                const m = dStr.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                const teacher = text.includes('JK') ? 'JKè€å¸«' : 'ä»¥ç³è€å¸«';
                calendar.addEvent({
                    title: name,
                    start: `${new Date().getFullYear()}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${times[1].replace('ï¼š',':').padStart(5,'0')}:00`,
                    end: `${new Date().getFullYear()}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${times[2].replace('ï¼š',':').padStart(5,'0')}:00`,
                    resourceId: text.includes('å¤§å»³')?'R1':(text.includes('ç´°æˆ¿')?'R2':(text.includes('18')?'R3':(text.includes('12')?'R4':'R5'))),
                    extendedProps: { teacher: teacher },
                    backgroundColor: text.includes('JK') ? '#10b981' : '#6366f1'
                });
            });
            updateToCloud();
            alert("åŒæ­¥æˆåŠŸ");
        }
    };

    // æ‹–æ‹½é¢æ¿é‚è¼¯
    let xOffset = 0, yOffset = 0, active = false;
    const dragStart = (e) => { if(e.target === header) active = true; initialX = e.clientX - xOffset; initialY = e.clientY - yOffset; };
    const drag = (e) => { if(active) { e.preventDefault(); xOffset = e.clientX - initialX; yOffset = e.clientY - initialY; panel.style.transform = `translate(${xOffset}px, ${yOffset}px)`; } };
    header.addEventListener("mousedown", dragStart);
    document.addEventListener("mousemove", drag);
    document.addEventListener("mouseup", () => active = false);

    // å¾ Firebase è¼‰å…¥
    eventRef.on('value', (snap) => {
        calendar.removeAllEvents();
        if (snap.val()) calendar.addEventSource(snap.val());
    });

    calendar.render();
});

document.getElementById('toggle-btn').onclick = function() {
    const content = document.getElementById('panel-content');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
    this.innerText = content.style.display === 'none' ? 'å±•é–‹' : 'æ”¶èµ·';
};
</script>
</body>
</html>
