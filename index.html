<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset='utf-8' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
  body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; overflow: hidden; }

  [data-resource-id="R5"] { border-right: 3px solid #000 !important; }

/* ç§»é™¤ä¹‹å‰çš„ nth-child ç›¸é—œä»£ç¢¼ï¼Œæ”¹ç”¨ä»¥ä¸‹æ–¹å¼ */

/* 1. è¨­å®šåŸºç¤èƒŒæ™¯è‰² (æ˜ŸæœŸäºŒã€å››ã€å…­ã€ä¸€) ç‚ºç™½è‰² */
.fc-day-sun, .fc-day-tue, .fc-day-thu, .fc-day-sat {
    background-color: #ffffff !important;
}

/* 2. è¨­å®šå€é–“èƒŒæ™¯è‰² (æ˜ŸæœŸæ—¥ã€ä¸‰ã€äº”) ç‚ºæ·ºè—/ç°è‰² */
/* ä½¿ç”¨ .fc-timegrid-col ç¢ºä¿æ•´æ¬„(å¾ä¸Šåˆ°ä¸‹)éƒ½æœ‰é¡è‰² */
.fc-timegrid-col.fc-day-mon, 
.fc-timegrid-col.fc-day-wed, 
.fc-timegrid-col.fc-day-fri {
    background-color: #f1f5f9 !important; /* æ¥µæ·ºçš„è—ç°è‰² */
}

/* 3. ä¿®æ­£ï¼šä»Šæ—¥é«˜äº® (é¿å…ä»Šæ—¥é¡è‰²è¢«å€é–“è‰²è¦†è“‹) */
.fc-timegrid-col.fc-day-today {
    background-color: rgba(254, 240, 138, 0.3) !important; 
}

/* ç¢ºä¿æ ¼ç·šåœ¨èƒŒæ™¯è‰²ä¹‹ä¸Š */
.fc-timegrid-slots td {
    z-index: 2;
}
  
  /* å…è¨±æ—¥æ›†å®¹å™¨åœ¨å…§å®¹éå¯¬æ™‚å‡ºç¾æ©«å‘æ»¾å‹•æ¢ */
.fc {
    min-width: 1000px; /* ç¢ºä¿é€±è¦–åœ–ä¸æœƒç¸®æˆä¸€åœ˜ */
}
#calendar {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

  .fc-timegrid-bg-harness,
  
/* å¼·åˆ¶é–‹å•Ÿè·¨æ¬„ä½é¸å–æ„Ÿæ‡‰ */
.fc-timegrid-cols table {
    pointer-events: all !important;
}

/* è®“æ‹–æ›³æ™‚çš„è—è‰²æ–¹æ¡†å¯ä»¥é¡¯ç¤ºåœ¨æœ€å‰é¢ */
.fc-highlight {
    z-index: 10 !important;
    background: rgba(99, 102, 241, 0.3) !important;
    border: 2px dashed #6366f1 !important;
  pointer-events: none;
}

/* ç¢ºä¿æˆ¿é–“æ¨™é¡Œä¸æœƒé®æ“‹æ»‘é¼  */
.fc-col-header-cell {
    pointer-events: auto !important;
}
  
#smart-input-panel {
    position: fixed; 
    top: 100px; 
    left: auto; 
    right: 50px; /* é è¨­é å³ */
    width: 320px; 
    z-index: 9999; /* ç¢ºä¿åœ¨æ—¥æ›†ä¹‹ä¸Š */
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    border: 1px solid #e2e8f0; 
    overflow: hidden;
    touch-action: none; /* é˜²æ­¢ç§»å‹•ç«¯å¹²æ“¾ */
}

#panel-header { 
    background: #6366f1; 
    color: white; 
    padding: 10px 15px; 
    cursor: grab; /* æç¤ºå¯æŠ“å– */
    font-weight: bold; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
}
#panel-header:active { cursor: grabbing; }
  #panel-content { padding: 15px; }
  #ai-text-input { width: 100%; height: 300px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; resize: vertical; margin-bottom: 10px; }
  #parse-btn { background: #6366f1; color: white; border: none; width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
  
  #calendar { max-width: 100%; height: 100vh; background: #fff; padding: 10px; box-sizing: border-box; }

  #custom-menu {
    display: none; position: fixed; z-index: 10000;
    background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    width: 180px; border: 1px solid #e2e8f0; overflow: hidden;
  }
  .menu-item { padding: 12px 15px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
  .menu-item:hover { background: #f8fafc; }
  
  /* é¸ä¸­ç‹€æ…‹çš„è¦–è¦ºæ•ˆæœ */
  .event-selected-style {
    border: 3px solid #facc15 !important;
    box-shadow: 0 0 12px rgba(250, 204, 21, 0.9) !important;
  }

  .hour-label { font-weight: bold; color: #1e293b; font-size: 13px; }
  .minute-label { font-size: 11px; color: #94a3b8; }
  .event-inner { padding: 4px; color: white; line-height: 1.2; height: 100%; border-radius: 4px; box-sizing: border-box; }
  .event-time { font-size: 10px; opacity: 0.9; margin-bottom: 2px; }
  .event-title { font-size: 13px; font-weight: bold; display: block; }
  .event-teacher { font-size: 11px; margin-top: 2px; }

  @media (max-width: 768px) { #smart-input-panel { width: 90%; right: 5%; top: 10px; } }

/* ç¢ºä¿ç©ºç™½æ ¼å­å¯ä»¥è¢«é»æ“Šå’Œæ‹–æ›³ */
.fc-timegrid-bg-harness {
    pointer-events: all !important;
}
.fc-slats td {
    pointer-events: all !important;
    z-index: 1 !important;
}

/* ç¢ºä¿é¸å–é«˜äº®ç¯„åœèƒ½æ„Ÿæ‡‰å³éµï¼Œä¸”é¡è‰²æ˜é¡¯ */
.fc-highlight {
    background: rgba(99, 102, 241, 0.4) !important;
    z-index: 4 !important;
    border: 2px dashed #6366f1 !important;
    /* ğŸ’¡ é—œéµï¼šå¿…é ˆè¨­ç‚º autoï¼Œå³éµé¸å–®æ‰èƒ½åµæ¸¬åˆ°å®ƒ */
    pointer-events: auto !important; 
}

/* é¿å…é¸å–çš„è—è‰²æ¡†æ¡†æ“‹ä½æ–‡å­— */
.fc-event {
    z-index: 10 !important;
}
  
</style>
</head>
<body>

<div id="custom-menu" style="display:none; position:fixed; z-index:9999; background:white; border:1px solid #ccc; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden;">
    <div id="menu-add-event" style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #10b981; font-weight: bold; display: none;" onclick="handleAction('addNewEvent')">â• æ–°å¢èª²å ‚</div>
    <div id="menu-paste-event" style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #3b82f6; font-weight: bold; display: none;" onclick="handleAction('paste')">ğŸ“‹ è²¼ä¸Šèª²å ‚</div>
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; font-weight: bold; background: #f9fafb;" onclick="handleAction('toggleSelect')">ğŸ”² å–æ¶ˆé¸å–æ­¤èª²å ‚</div> 
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="handleAction('editName')">âœï¸ ä¿®æ”¹å­¸ç”Ÿå</div>
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="handleAction('editTeacher')">ğŸ‘©â€ğŸ« ä¿®æ”¹è€å¸«å</div>
    <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #6366f1;" onclick="handleAction('copy')">ğŸ“‹ Copy é¸ä¸­èª²å ‚</div>
    <div style="padding: 10px 15px; cursor: pointer; color: red;" onclick="handleAction('delete')">ğŸ—‘ï¸ åˆªé™¤é¸ä¸­èª²å ‚</div>
</div>

  <div id="smart-input-panel">
    <div id="panel-header"><span>é›²ç«¯æ’èª²åŠ©æ‰‹</span><button id="toggle-btn" style="cursor:pointer; background:none; border:none; color:white;">æ”¶èµ·</button></div>
    <div id="panel-content">
      <textarea id="ai-text-input" placeholder="åœ¨æ­¤è²¼ä¸Šè¨Šæ¯å…§å®¹..."></textarea>
      <button id="parse-btn">è§£æä¸¦åŒæ­¥è‡³é›²ç«¯</button>
    </div>
  </div>

  <div id='calendar'></div>
  
  <script>

        // 1. å®šç¾©é è¨­è‰²ç›¤ (æ‚¨å¯ä»¥éš¨æ„å¢åŠ å–œæ­¡çš„é¡è‰²)
const colorPalette = [
    '#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', 
    '#06b6d4', '#f43f5e', '#14b8a6', '#f97316', '#3b82f6',
    '#22c55e', '#ef4444', '#eab308', '#a855f7', '#0ea5e9'
];

let teacherColorMap = {};
let colorIndex = 0;

function getTeacherColor(name) {
    if (!name) return '#94a3b8';
    // æ¸…é™¤ç©ºæ ¼ç¢ºä¿åå­—åŒ¹é…
    const cleanName = name.trim();
    if (!teacherColorMap[cleanName]) {
        teacherColorMap[cleanName] = colorPalette[colorIndex % colorPalette.length];
        colorIndex++;
    }
    return teacherColorMap[cleanName];
}
    
    
    
    // --- 1. æ ¸å¿ƒè®Šæ•¸èˆ‡ Firebase é…ç½® ---
const firebaseConfig = {
    apiKey: "AIzaSyAFPtHLY-LqLnDiKUot0mpAPchrC7iqAXg",
    authDomain: "lckroomtable.firebaseapp.com",
    databaseURL: "https://lckroomtable-default-rtdb.firebaseio.com",
    projectId: "lckroomtable",
    storageBucket: "lckroomtable.firebasestorage.app",
    messagingSenderId: "934661729012",
    appId: "1:934661729012:web:14b19af989cd72b2370ca1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const eventRef = db.ref('bookings');

// å¿…é ˆå®šç¾©åœ¨ DOMContentLoaded ä¹‹å¤–ï¼ŒhandleAction æ‰èƒ½è®€å–
let calendar, selectedEventInfo, copiedEventsBatch = [], multiSelectIds = new Set(); currentSelection = null;

// è¼”åŠ©å‡½å¼
const getEvId = (ev) => ev.startStr + "_" + ev.title + "_" + (ev.getResources()[0]?.id || "");

const updateToCloud = () => {
    if (!calendar) return;
    const events = calendar.getEvents().map(e => ({
        title: e.title, start: e.startStr, end: e.endStr,
        resourceId: e.getResources()[0]?.id, extendedProps: e.extendedProps,
        backgroundColor: e.backgroundColor || '#6366f1'
    }));
    eventRef.set(events);
};

function showCustomMenu(info) {
    if (!info.event) return; 

    selectedEventInfo = info.event;
    const menu = document.getElementById('custom-menu');
    menu.style.display = 'block';
    
    // æ ¹æ“šæ»‘é¼ å³éµä½ç½®å®šä½
    menu.style.left = info.jsEvent.clientX + 'px';
    menu.style.top = info.jsEvent.clientY + 'px';

    const closeMenu = (e) => { 
        if(!menu.contains(e.target)) { 
            menu.style.display = 'none'; 
            document.removeEventListener('mousedown', closeMenu); 
        } 
    };
    setTimeout(() => document.addEventListener('mousedown', closeMenu), 50);
}

// --- 2. é¸å–®æŒ‰éˆ•åŠŸèƒ½ ---
window.handleAction = function(action) {
    const menu = document.getElementById('custom-menu');
    const addBtn = document.getElementById('menu-add-event');
    const info = window.currentSelection; // æ‹–æ›³é¸å–çš„ç¯„åœ
    const ev = selectedEvent;            // é»æ“Šç¾æœ‰èª²å ‚çš„ç‰©ä»¶

// åœ¨ handleAction å‡½å¼å…§çš„ if (action === 'addNewEvent' ...) å€å¡Šå¾Œé¢åŠ å…¥ï¼š
if (action === 'paste' && info) {
    if (copiedEventsBatch.length === 0) {
        alert("å‰ªè²¼ç°¿ä¸­æ²’æœ‰èª²å ‚è³‡è¨Šã€‚");
        return;
    }

    copiedEventsBatch.forEach(evData => {
        // æ ¹æ“šé»æ“Šçš„ä½ç½® (info.start) åŠ ä¸Š åç§»é‡ (offset) è¨ˆç®—æ–°æ™‚é–“
        const newStart = new Date(info.start.getTime() + evData.offset);
        const newEnd = new Date(newStart.getTime() + evData.duration);

        calendar.addEvent({
            title: evData.title,
            start: newStart,
            end: newEnd,
            resourceId: info.resource.id, // è²¼åˆ°ç›®å‰é¸ä¸­çš„æˆ¿é–“
            extendedProps: evData.extendedProps,
            backgroundColor: evData.backgroundColor
        });
    });

    updateToCloud();
    alert(`å·²è²¼ä¸Š ${copiedEventsBatch.length} å ‚èª²å ‚ã€‚`);
    calendar.unselect();
}
  
    if (action === 'addNewEvent' && info) {
        const studentName = prompt('è«‹è¼¸å…¥å­¸ç”Ÿå§“åï¼š');
        if (studentName) {
            const teacherName = prompt('è«‹è¼¸å…¥è€å¸«å§“åï¼š', 'ä»¥ç³è€å¸«');
            if (teacherName) {
                calendar.addEvent({
                    title: studentName,
                    start: info.startStr,
                    end: info.endStr,
                    resourceId: info.resource.id,
                    extendedProps: { teacher: teacherName },
                    backgroundColor: getTeacherColor(teacherName)
                });
                updateToCloud();
                calendar.unselect();
                window.currentSelection = null;
            }
        }
    } else if (ev) { 
        // é€™è£¡è™•ç†æ‚¨åŸæœ¬çš„ editName, editTeacher, copy, delete åŠŸèƒ½
        const evId = getEvId(ev);
        if (action === 'editName') {
            const n = prompt('ä¿®æ”¹å­¸ç”Ÿåï¼š', ev.title);
            if(n) { ev.setProp('title', n); updateToCloud(); }
        } else if (action === 'editTeacher') {
            const t = prompt('ä¿®æ”¹è€å¸«ï¼š', ev.extendedProps.teacher);
            if(t) {
                ev.setExtendedProp('teacher', t);
                ev.setProp('backgroundColor', getTeacherColor(t));
                updateToCloud();
            }
        } else if (action === 'copy') {
        // æ‰¾åˆ°æ‰€æœ‰è¢«å‹¾é¸ï¼ˆæœ‰é»ƒè‰²æ¡†ï¼‰çš„èª²å ‚
        const targets = calendar.getEvents().filter(e => multiSelectIds.has(getEvId(e)));
        // å¦‚æœæ²’æœ‰å‹¾é¸ä»»ä½•èª²å ‚ï¼Œå°±åªè¤‡è£½ç•¶å‰é»æ“Šçš„é‚£ä¸€å€‹
        const finalT = targets.length > 0 ? targets : [ev];
        
        finalT.sort((a, b) => a.start - b.start);
        const ref = finalT[0].start;
        copiedEventsBatch = finalT.map(e => ({
            title: e.title, 
            offset: e.start - ref, 
            duration: e.end - e.start,
            extendedProps: {...e.extendedProps}, 
            backgroundColor: e.backgroundColor
        }));
        alert(`å·²è¤‡è£½ ${finalT.length} å ‚èª²ï¼Œé»æ“Šç©ºç™½è™•å¯è²¼ä¸Šã€‚`);
        multiSelectIds.clear();
    } else if (action === 'delete') {
        // 1. å–å¾—ç•«é¢ä¸Šæ‰€æœ‰çš„äº‹ä»¶
        const allEvents = calendar.getEvents();
        
        // 2. ç¯©é¸å‡º ID å­˜åœ¨æ–¼ multiSelectIds ä¸­çš„äº‹ä»¶ç‰©ä»¶
        // å¦‚æœæ²’æœ‰å¤šé¸ï¼Œå‰‡åªæŠ“å–ç•¶å‰é»æ“Šçš„é‚£ä¸€å€‹ (ev)
        let finalD = allEvents.filter(e => multiSelectIds.has(getEvId(e)));
        if (finalD.length === 0) finalD = [ev];
        
        if (confirm(`ç¢ºå®šè¦åˆªé™¤é€™ ${finalD.length} å ‚èª²å ‚å—ï¼Ÿ`)) {
            // ğŸ’¡ é—œéµï¼šå…ˆåœæ­¢ Firebase ç›£è½ï¼Œé¿å…åˆªé™¤éç¨‹ä¸­é›²ç«¯æ•¸æ“šè·³å›
            eventRef.off('value'); 

            // 3. åŸ·è¡Œåˆªé™¤
            finalD.forEach(e => {
                e.remove(); 
            });

            // 4. æ¸…ç©ºé¸å–ç´€éŒ„
            multiSelectIds.clear();

            // 5. ç«‹å³åŒæ­¥åˆ°é›²ç«¯
            const remainingEvents = calendar.getEvents().map(e => ({
                title: e.title, 
                start: e.startStr, 
                end: e.endStr,
                resourceId: e.getResources()[0]?.id, 
                extendedProps: e.extendedProps,
                backgroundColor: e.backgroundColor
            }));
            
            eventRef.set(remainingEvents).then(() => {
                // 6. åŒæ­¥æˆåŠŸå¾Œï¼Œé‡å•Ÿ Firebase ç›£è½
                eventRef.on('value', snap => {
                    calendar.removeAllEvents();
                    if (snap.val()) calendar.addEventSource(Object.values(snap.val()));
                });
                alert("åˆªé™¤æˆåŠŸä¸¦å·²åŒæ­¥é›²ç«¯");
            });
        }
    }
    }
    menu.style.display = 'none';
    addBtn.style.display = 'none';
};

// --- 3. åˆå§‹åŒ–æ—¥æ›† ---
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');

calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'resourceTimeGridWeek', 
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'resourceTimeGridDay,resourceTimeGridWeek'
        },
        locale: 'zh-tw',
        schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
        
        // --- é—œéµä¿®æ”¹ï¼šéš±è— all-day æ¬„ä½ ---
        allDaySlot: false,

        // æˆ¿é–“åœ¨æ—¥æœŸä¹‹ä¸‹
        datesAboveResources: true, 

        // é™åˆ¶æ™‚é–“ç‚ºä¸Šåˆ 8 é»è‡³æ™šä¸Š 10 é»
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',

        selectable: true,
        unselectAuto: false,
        longPressDelay: 50,
        editable: true,
        slotDuration: '00:15:00',
        slotLabelInterval: '00:15:00',


  
        // ç°¡ç´„æ™‚é–“é¢¨æ ¼ (å°æ™‚ã€15ã€30ã€45)
        slotLabelContent: (arg) => {
            const hour = arg.date.getHours();
            const min = arg.date.getMinutes();
            if (min === 0) return { html: `<div class="hour-label">${hour}æ™‚</div>` };
            return { html: `<div class="minute-label">${min}</div>` };
        },

        // æ—¥æœŸæ¨™é ­æ ¼å¼
        dayHeaderContent: (arg) => {
            const date = arg.date;
            const days = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'];
            return { html: `<b>${date.getMonth()+1}/${date.getDate()}</b> <small>(${days[date.getDay()]})</small>` };
        },

        resources: [
            { id: 'R1', title: 'èª ä¿¡å¤§å»³' }, { id: 'R2', title: 'èª ä¿¡ç´°æˆ¿' },
            { id: 'R3', title: 'å˜‰åRm 18' }, { id: 'R4', title: 'å˜‰åRm 12' }, { id: 'R5', title: 'å…¶ä»–' }
        ],

        // ... å…¶é¤˜ eventContent, eventClick, select ç­‰é‚è¼¯ä¿æŒä¸è®Š

eventContent: (arg) => {
    const isSelected = multiSelectIds.has(getEvId(arg.event));
    const teacher = arg.event.extendedProps.teacher || '';
    
    // å„ªå…ˆä½¿ç”¨äº‹ä»¶å·²å­˜çš„é¡è‰²ï¼Œè‹¥ç„¡å‰‡ç¾å ´åˆ†é…
    const bgColor = arg.event.backgroundColor || getTeacherColor(teacher);
    
    return { 
        html: `<div class="event-inner ${isSelected ? 'event-selected-style' : ''}" style="background-color:${bgColor}">
            <div class="event-time">${arg.timeText}</div>
            <div class="event-title">${arg.event.title}</div>
            <div class="event-teacher">ğŸ‘¤ ${teacher}</div>
        </div>` 
    };
},

eventDidMount: function(info) {
            info.el.addEventListener('contextmenu', function(ev) {
                ev.preventDefault();
                ev.stopPropagation(); 

                selectedEvent = info.event; // ç´€éŒ„ç›®å‰é»æ“Šçš„æ˜¯å“ªä¸€é–€èª²
                const id = getEvId(info.event);
                const menu = document.getElementById('custom-menu');
                const addBtn = document.getElementById('menu-add-event');

                if (multiSelectIds.has(id)) {
                    addBtn.style.display = 'none'; // é»ç¾æœ‰èª²å ‚æ™‚ï¼Œéš±è—ã€Œæ–°å¢ã€æŒ‰éˆ•
                    menu.style.display = 'block';
                    menu.style.left = ev.clientX + 'px';
                    menu.style.top = ev.clientY + 'px';
                }
            });
        },
  
eventClick: function(info) {
    info.jsEvent.preventDefault();
    const id = getEvId(info.event);
    
    if (multiSelectIds.has(id)) {
        // å¦‚æœå·²ç¶“é¸å–ï¼Œé»æ“Šå‰‡å–æ¶ˆé¸å–
        multiSelectIds.delete(id);
    } else {
        // å¦‚æœæœªé¸å–ï¼Œé»æ“Šå‰‡åŠ å…¥é¸å–
        multiSelectIds.add(id);
    }
    calendar.render(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é»ƒè‰²å¤–æ¡†æ¨£å¼
},

// ä¿®æ­£å¾Œçš„ selectï¼šåªç´€éŒ„è³‡è¨Šï¼Œä¸å½ˆå‡ºè¦–çª—
        
  select: function(info) {
            window.currentSelection = info; 
        },
  
selectable: true,
        unselectAuto: false, // ğŸ’¡ è®“è—è‰²ç¯„åœç•™è‘—ï¼Œä¸è¦è‡ªå‹•æ¶ˆå¤±

        // ä¿®æ­£å¾Œçš„ selectï¼šåªç´€éŒ„è³‡è¨Šï¼Œä¸å½ˆå‡ºè¦–çª—
        select: function(info) {
            window.currentSelection = info; 
        },

        // ğŸ’¡ é€™è£¡æ˜¯é—œéµï¼šæ–°å¢å³éµé¸å–®ç›£è½å™¨
viewDidMount: function(arg) {
    arg.el.addEventListener('contextmenu', function(ev) {
        ev.preventDefault();
        const menu = document.getElementById('custom-menu');
        const addBtn = document.getElementById('menu-add-event');
        const pasteBtn = document.getElementById('menu-paste-event'); // æ–°å¢é€™è¡Œ
        
        const isOverSelection = ev.target.closest('.fc-highlight');
        
        if (isOverSelection && window.currentSelection) {
            // å¦‚æœæœ‰é¸å–ç¯„åœï¼Œé¡¯ç¤ºã€Œæ–°å¢ã€
            addBtn.style.display = 'block';
            
            // å¦‚æœå‰ªè²¼ç°¿æœ‰æ±è¥¿ï¼Œé¡¯ç¤ºã€Œè²¼ä¸Šã€
            pasteBtn.style.display = copiedEventsBatch.length > 0 ? 'block' : 'none';
            
            menu.style.display = 'block';
            menu.style.left = ev.clientX + 'px';
            menu.style.top = ev.clientY + 'px';

            const closeMenu = (e) => {
                if(!menu.contains(e.target)) {
                    menu.style.display = 'none';
                    document.removeEventListener('mousedown', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('mousedown', closeMenu), 50);
        }
    });
},

        eventChange: updateToCloud,
        eventRemove: updateToCloud
    }); 
  
  // ğŸ’¡ é€™æ˜¯æ—¥æ›†é…ç½®ç‰©ä»¶çš„çµå°¾æ‹¬è™Ÿ

    calendar.render();


  
  
    // Firebase å¯¦æ™‚åŒæ­¥
// Firebase å¯¦æ™‚åŒæ­¥ä¿®æ­£ç‰ˆ
eventRef.on('value', snap => {
    calendar.removeAllEvents();
    const data = snap.val();
    if (data) {
        const eventsArray = Object.values(data).map(e => {
            // æŠ“å–è€å¸«åï¼Œå¦‚æœèˆŠè³‡æ–™æ²’æœ‰é€™å€‹æ¬„ä½ï¼Œé è¨­ç‚ºä»¥ç³è€å¸«
            const teacherName = (e.extendedProps && e.extendedProps.teacher) 
                                ? e.extendedProps.teacher 
                                : 'ä»¥ç³è€å¸«';
            
            // ğŸ’¡ é—œéµï¼šæ¯æ¬¡å¾é›²ç«¯æŠ“ä¸‹ä¾†æ™‚ï¼Œä¸çœ‹èˆŠé¡è‰²ï¼Œç›´æ¥é‡æ–°è¨ˆç®—é¡è‰²
            const correctColor = getTeacherColor(teacherName);
            
            return {
                ...e,
                backgroundColor: correctColor,
                borderColor: correctColor
            };
        });
        calendar.addEventSource(eventsArray);
    }
});
  
    // AI è§£æç¶å®š
document.getElementById('parse-btn').onclick = function() {
    const text = document.getElementById('ai-text-input').value;
    const nameMatch = text.match(/([^\s\n\d,ï¼Œ.]{2,4})(?=[å·²å·³]ç¹³|åŒå­¸|å…ˆç”Ÿ|å°å§|å­¸è²»)/);
    const dateMatch = text.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/g);
    const timeMatch = text.match(/(\d{1,2}[:ï¼š]\d{2})[-â€“â€”](\d{1,2}[:ï¼š]\d{2})/);

    if (dateMatch && timeMatch) {
        const teacherMatch = text.match(/[|ï½œ]\s*(\S+?)(?:è€å¸«)?(?:\n|$|\s)/);
        const teacher = teacherMatch ? (teacherMatch[1].includes('è€å¸«') ? teacherMatch[1] : teacherMatch[1] + 'è€å¸«') : 'ä»¥ç³è€å¸«';
        
        // ç²å–ç•¶å‰ç³»çµ±çš„å¹´ä»½èˆ‡æœˆä»½
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1; // 12

        dateMatch.forEach(d => {
            const m = d.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/);
            const inputMonth = parseInt(m[1]);
            const inputDay = parseInt(m[2]);

            // --- è·¨å¹´é‚è¼¯ä¿®æ­£ ---
            // å¦‚æœç¾åœ¨æ˜¯ 12 æœˆï¼Œä½†è¼¸å…¥çš„æœˆä»½æ˜¯ 1 æœˆæˆ– 2 æœˆï¼Œå¹´ä»½è‡ªå‹•è¨­ç‚ºæ˜å¹´ (2026)
            let targetYear = currentYear;
            if (currentMonth === 12 && inputMonth < 3) {
                targetYear = currentYear + 1;
            } 
            // åä¹‹ï¼Œå¦‚æœç¾åœ¨æ˜¯ 1 æœˆï¼Œä½†è¼¸å…¥ 12 æœˆï¼Œå‰‡è¦–ç‚ºå»å¹´ (2025)
            else if (currentMonth === 1 && inputMonth === 12) {
                targetYear = currentYear - 1;
            }
            // ------------------

            const startStr = `${targetYear}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${timeMatch[1].replace('ï¼š',':').padStart(5,'0')}:00`;
            const endStr = `${targetYear}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}T${timeMatch[2].replace('ï¼š',':').padStart(5,'0')}:00`;

            calendar.addEvent({
                title: nameMatch ? nameMatch[1] : "æ–°å­¸ç”Ÿ",
                start: startStr,
                end: endStr,
                resourceId: text.includes('å¤§å»³') ? 'R1' : (text.includes('ç´°æˆ¿') ? 'R2' : (text.includes('18') ? 'R3' : (text.includes('12') ? 'R4' : 'R5'))),
                extendedProps: { teacher: teacher },
                backgroundColor: getTeacherColor(teacher)
            });
        });
        updateToCloud();
        alert("åŒæ­¥æˆåŠŸï¼å·²æ’å…¥ " + targetYear + " å¹´èª²ç¨‹ã€‚");
    } else {
        alert("è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªè¨Šæ¯æ ¼å¼ï¼ˆéœ€åŒ…å«æ—¥æœŸèˆ‡æ™‚é–“ï¼‰");
    }
};




// é¢æ¿æ‹–æ‹½èˆ‡æ”¶åˆé‚è¼¯
const panel = document.getElementById('smart-input-panel'), header = document.getElementById('panel-header');
let active = false, xOffset = 0, yOffset = 0, initX, initY;
header.onmousedown = (e) => { active = true; initX = e.clientX - xOffset; initY = e.clientY - yOffset; };
document.onmousemove = (e) => { if(active) { xOffset = e.clientX - initX; yOffset = e.clientY - initY; panel.style.transform = `translate(${xOffset}px, ${yOffset}px)`; } };
document.onmouseup = () => active = false;
// ... (ä¹‹å‰çš„é¢æ¿æ‹–æ‹½èˆ‡æ”¶åˆé‚è¼¯ä¿æŒä¸è®Š)
document.getElementById('toggle-btn').onclick = function() {
    const c = document.getElementById('panel-content');
    c.style.display = (c.style.display === 'none' ? 'block' : 'none');
    this.innerText = (c.style.display === 'none' ? 'å±•é–‹' : 'æ”¶èµ·');
  };

// ğŸ’¡ é—œéµä¿®æ­£ï¼šç¢ºä¿é€™è£¡æ­£ç¢ºé–‰åˆ DOMContentLoaded
}); 
</script>
</body>
</html>
