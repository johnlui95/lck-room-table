<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset='utf-8' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js'></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
  body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; }
  
  /* ä»‹é¢å¤–æ®¼ */
  #calendar-container { padding: 15px; background: #fff; height: 95vh; }
  #calendar { max-width: 100%; height: 100%; }

  /* ğŸŸ¢ ä¿®æ”¹ï¼šè‡ªå®šç¾©æ—¥æœŸèˆ‡è³‡æºçš„å±¤ç´šé¢¨æ ¼ */
  .fc-col-header-cell-cushion { padding: 8px 4px !important; }
  .header-date-box { display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .header-date { font-size: 16px; font-weight: bold; color: #1e293b; }
  .header-day { font-size: 13px; color: #64748b; margin-top: 2px; }
  .resource-title { font-size: 14px; font-weight: bold; color: #1e293b; padding: 4px 0; border-top: 1px solid #e2e8f0; width: 100%; text-align: center; }

  /* ğŸŸ¢ ä¿®æ”¹ï¼šæ™‚é–“è»¸æ¨™ç±¤é¢¨æ ¼ (æ¯”ç…§åœ–ç‰‡) */
  .hour-label { font-weight: bold; color: #334155; font-size: 14px; border-bottom: 1px solid #cbd5e1; display: inline-block; width: 100%; text-align: right; padding-right: 5px; }
  .minute-label { font-size: 11px; color: #94a3b8; text-align: right; padding-right: 5px; display: block; margin-top: -2px; }

  /* äº‹ä»¶é¢¨æ ¼ */
  .event-inner { padding: 4px; color: white; line-height: 1.3; height: 100%; border-radius: 4px; }
  .event-time { font-size: 10px; font-weight: bold; margin-bottom: 2px; white-space: nowrap; overflow: hidden; }
  .event-title { font-size: 13px; font-weight: 900; display: block; }
  .event-teacher { font-size: 11px; margin-top: 3px; display: flex; align-items: center; }

  /* å´é‚Šæ§åˆ¶é¢æ¿ */
  #smart-input-panel {
    position: fixed; top: 10px; right: 10px; width: 280px; z-index: 9999;
    background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #cbd5e1;
  }
  #panel-header { background: #475569; color: white; padding: 8px 12px; cursor: move; border-radius: 8px 8px 0 0; font-size: 14px; display: flex; justify-content: space-between; }
  #panel-content { padding: 12px; }
  #ai-text-input { width: 100%; height: 80px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 8px; font-size: 12px; margin-bottom: 8px; box-sizing: border-box; }
  #parse-btn { background: #6366f1; color: white; border: none; width: 100%; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; }
</style>
</head>
<body>

  <div id="smart-input-panel">
    <div id="panel-header"><span>é›²ç«¯æ’èª²åŠ©æ‰‹</span><button id="toggle-btn" style="color:white; background:none; border:none; cursor:pointer;">æ”¶èµ·</button></div>
    <div id="panel-content">
      <textarea id="ai-text-input" placeholder="åœ¨æ­¤è²¼ä¸Šè¨Šæ¯å…§å®¹..."></textarea>
      <button id="parse-btn">è§£æä¸¦åŒæ­¥è‡³é›²ç«¯</button>
    </div>
  </div>

  <div id="calendar-container">
    <div id='calendar'></div>
  </div>

<script>
    // Firebase åˆå§‹åŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyAFPtHLY-LqLnDiKUot0mpAPchrC7iqAXg",
      authDomain: "lckroomtable.firebaseapp.com",
      databaseURL: "https://lckroomtable-default-rtdb.firebaseio.com",
      projectId: "lckroomtable",
      storageBucket: "lckroomtable.firebasestorage.app",
      messagingSenderId: "934661729012",
      appId: "1:934661729012:web:14b19af989cd72b2370ca1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const eventRef = db.ref('bookings');

    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'resourceTimeGridWeek',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'resourceTimeGridDay,resourceTimeGridWeek' },
        locale: 'zh-tw',
        firstDay: 1, // é€±ä¸€é–‹å§‹
        schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
        
        // ğŸŸ¢ ä¿®æ”¹ï¼šå°‡æ—¥æœŸæ”¾åœ¨è³‡æºï¼ˆæˆ¿é–“ï¼‰ä¹‹ä¸Š
        datesAboveResources: false, 

        // ğŸŸ¢ ä¿®æ”¹ï¼šå®šç¾©é ‚éƒ¨æ¨™é¡Œï¼ˆæ—¥æœŸ + æˆ¿é–“ï¼‰
        dayHeaderContent: function(arg) {
          const m = arg.date.getMonth() + 1;
          const d = arg.date.getDate();
          const dayName = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][arg.date.getDay()];
          
          // å¦‚æœæœ‰è³‡æºï¼ˆæˆ¿é–“ï¼‰ï¼Œé¡¯ç¤ºåœ¨æ—¥æœŸä¸‹æ–¹
          const resourceTitle = arg.resource ? `<div class="resource-title">${arg.resource.title}</div>` : '';
          
          return { html: `
            <div class="header-date-box">
              <div class="header-date">${m}/${d}</div>
              <div class="header-day">(${dayName})</div>
              ${resourceTitle}
            </div>` 
          };
        },

        // ğŸŸ¢ ä¿®æ”¹ï¼šæ™‚é–“è»¸æ¨™ç±¤è¨­å®š (æ¯15åˆ†é˜ä¸€æ ¼)
        slotDuration: '00:15:00',
        slotLabelInterval: '00:15:00',
        slotMinTime: '08:00:00',
        slotMaxTime: '22:00:00',
        allDaySlot: false,
        
        slotLabelContent: function(arg) {
          const hour = arg.date.getHours();
          const min = arg.date.getMinutes();
          const ampm = hour >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
          const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
          
          if (min === 0) {
            return { html: `<div class="hour-label">${ampm}${displayHour}æ™‚</div>` };
          } else {
            return { html: `<div class="minute-label">${ampm}${displayHour}:${String(min).padStart(2, '0')}</div>` };
          }
        },

        // äº‹ä»¶å…§å®¹è‡ªå®šç¾©
        eventContent: function(arg) {
          const teacher = arg.event.extendedProps.teacher || 'æœªæŒ‡å®š';
          return { 
            html: `<div class="event-inner">
                    <div class="event-time">${arg.timeText}</div>
                    <div class="event-title">${arg.event.title}</div>
                    <div class="event-teacher">ğŸ‘¤ ${teacher}</div>
                   </div>` 
          };
        },

        resources: [
          { id: 'R1', title: 'èª ä¿¡å¤§å»³' },
          { id: 'R2', title: 'èª ä¿¡ç´°æˆ¿' },
          { id: 'R3', title: 'å˜‰åRm 18' },
          { id: 'R4', title: 'å˜‰åRm 12' }
        ],

        editable: true,
        selectable: true,
        eventChange: updateToCloud,
        eventRemove: updateToCloud,

        // æ–°å¢èª²ç¨‹
        select: function(info) {
          const title = prompt('å­¸ç”Ÿå§“å:');
          if (title) {
            const teacher = prompt('è€å¸«å§“å:', 'ä»¥ç³è€å¸«');
            calendar.addEvent({
              title: title,
              start: info.startStr,
              end: info.endStr,
              resourceId: info.resource.id,
              extendedProps: { teacher: teacher },
              backgroundColor: teacher === 'ä»¥ç³è€å¸«' ? '#6366f1' : '#10b981'
            });
            updateToCloud();
          }
          calendar.unselect();
        }
      });

      function updateToCloud() {
        const events = calendar.getEvents().map(e => ({
          title: e.title, start: e.startStr, end: e.endStr,
          resourceId: e.getResources()[0]?.id,
          extendedProps: e.extendedProps,
          backgroundColor: e.backgroundColor
        }));
        eventRef.set(events);
      }

      eventRef.on('value', (snap) => {
        calendar.removeAllEvents();
        calendar.addEventSource(snap.val() || []);
      });

      calendar.render();

      // é¢æ¿æ‹–æ‹½èˆ‡æ”¶åˆé‚è¼¯
      const panel = document.getElementById('smart-input-panel');
      const toggleBtn = document.getElementById('toggle-btn');
      toggleBtn.onclick = () => {
        const content = document.getElementById('panel-content');
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
        toggleBtn.innerText = content.style.display === 'none' ? 'å±•é–‹' : 'æ”¶èµ·';
      };
    });
</script>
</body>
</html>
